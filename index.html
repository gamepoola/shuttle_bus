<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laya shuttle bus</title>
  <style>
    :root{
      --bg1:#07121f; --bg2:#0b1a2a;
      --text:#f5f0e6; --muted:#cbbfae;
      --gold:#836A45;
      --gold2:#B0A390;
      --ok:#22c55e;
      --danger:#ff5a5f;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --line: rgba(131,106,69,.22);
      --yellow:#f2c94c;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(131,106,69,.14), transparent 60%),
        radial-gradient(900px 700px at 90% 20%, rgba(176,163,144,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    header{
      position: sticky; top: 0;
      backdrop-filter: blur(10px);
      background: rgba(7,18,31,.65);
      border-bottom: 1px solid var(--line);
      z-index: 10;
    }
    .wrap{ max-width: 1120px; margin: 0 auto; padding: 18px; }

    .brand{ display:flex; align-items:center; justify-content:space-between; gap: 12px; padding: 14px 18px; }
    .brand-left{ display:flex; align-items:center; gap:12px; min-width:0; }

    .mark{
      width: 46px; height: 46px; border-radius: 16px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.14), transparent 55%),
                  linear-gradient(135deg, rgba(131,106,69,.38), rgba(131,106,69,.08));
      border: 1px solid rgba(131,106,69,.35);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight: 900;
      color: var(--gold2);
      letter-spacing: .5px;
      font-size: 18px;
      flex: 0 0 auto;
    }
    h1{ margin:0; font-size: 20px; letter-spacing: .6px; }
    .sub{ margin:2px 0 0 0; color: var(--muted); font-size: 13.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70vw; }

    .nav{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(131,106,69,.22);
      background: rgba(15,36,56,.35);
      color: var(--text);
      font-size: 14px;
      font-weight: 650;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      display:inline-block;
    }
    .chip.active{ border-color: rgba(131,106,69,.55); background: rgba(131,106,69,.14); color: var(--gold2); }

    .card{
      background: linear-gradient(180deg, rgba(15,36,56,.78), rgba(12,29,47,.72));
      border: 1px solid rgba(131,106,69,.18);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: 16px 16px 12px 16px;
      border-bottom: 1px solid rgba(131,106,69,.16);
      display:flex; align-items:flex-end; justify-content:space-between; gap: 12px;
      flex-wrap:wrap;
    }
    .card-h h2{ margin:0; font-size: 17px; letter-spacing:.4px; }
    .card-h .hint{ margin:4px 0 0 0; color: var(--muted); font-size: 13.5px; line-height: 1.5; }
    .card-b{ padding: 14px 16px 16px 16px; }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1.1fr .9fr; } }

    .slots{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 640px){ .slots{ grid-template-columns: 1fr 1fr; } }

    .slot{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(7,18,31,.35);
    }
    .slot .time{ font-size: 22px; font-weight: 900; letter-spacing:.3px; }
    .slot .seat{ font-size: 15.5px; color: var(--muted); }
    .slot .seat b{ font-size: 20px; color: var(--ok); }
    .slot .seat b.danger{ color: var(--danger); }
    .slot .meta{ display:flex; flex-direction:column; gap: 6px; min-width:0; }

    .badge{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 8px 11px; border-radius: 999px;
      background: rgba(131,106,69,.10);
      border: 1px solid rgba(131,106,69,.20);
      color: var(--muted); font-size: 13.5px; font-weight: 650;
    }
    .dot{ width: 9px; height: 9px; border-radius: 50%; background: var(--gold); box-shadow: 0 0 0 4px rgba(131,106,69,.12); }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 4px rgba(34,197,94,.16); }
    .dot.bad{ background: var(--danger); box-shadow: 0 0 0 4px rgba(255,90,95,.14); }

    .btn{
      appearance:none; border: 1px solid rgba(131,106,69,.35);
      background: rgba(131,106,69,.14);
      color: var(--gold2);
      padding: 11px 14px;
      border-radius: 16px;
      font-weight: 850;
      letter-spacing: .2px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
      min-width: 110px;
      text-align:center;
      font-size: 15px;
    }
    .btn:hover{ border-color: rgba(131,106,69,.6); background: rgba(131,106,69,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity: .55; cursor:not-allowed; transform:none; }

    /* Keep old style for “ปิดแล้ว” */
    .btn.primary{ background: linear-gradient(135deg, rgba(131,106,69,.22), rgba(131,106,69,.12)); border-color: rgba(131,106,69,.55); color: var(--text); }

    /* Yellow for “เลือก” */
    .btn.pick{
      background: linear-gradient(135deg, rgba(242,201,76,.95), rgba(242,201,76,.60));
      border-color: rgba(242,201,76,.85);
      color: #0b1a2a;
    }
    .btn.pick:hover{
      background: linear-gradient(135deg, rgba(242,201,76,1), rgba(242,201,76,.72));
      border-color: rgba(242,201,76,1);
    }

    .btn.danger{ background: rgba(255,90,95,.10); border-color: rgba(255,90,95,.45); color: #ffb0b3; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }

    .field{ display:flex; flex-direction:column; gap:6px; width: 100%; }
    label{ color: var(--muted); font-size: 13.5px; font-weight: 650; }
    input, select{
      width: 100%;
      padding: 13px 12px;
      border-radius: 16px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(7,18,31,.35);
      color: var(--text);
      outline:none;
      font-size: 17px;
      font-weight: 650;
    }
    select{ cursor:pointer; }
    input:focus, select:focus{ border-color: rgba(131,106,69,.55); box-shadow: 0 0 0 4px rgba(131,106,69,.12); }

    .mini{
      margin-top: 10px;
      border-top: 1px solid rgba(131,106,69,.16);
      padding-top: 10px;
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.65;
    }
    .divider{ height:1px; background: rgba(131,106,69,.16); margin: 12px 0; }

    table{ width: 100%; border-collapse: collapse; overflow:hidden; border-radius: 18px; border: 1px solid rgba(131,106,69,.18); background: rgba(7,18,31,.25); }
    th, td{ padding: 11px 11px; font-size: 13px; border-bottom: 1px solid rgba(131,106,69,.14); text-align:left; }
    th{ color: var(--muted); font-weight: 800; }
    tr:last-child td{ border-bottom:none; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(7,18,31,.88);
      border: 1px solid rgba(131,106,69,.25);
      box-shadow: var(--shadow);
      padding: 12px 14px;
      border-radius: 18px;
      max-width: 92vw;
      width: 620px;
      display:none;
      z-index: 30;
    }
    .toast.show{ display:block; animation: pop .12s ease-out; }
    @keyframes pop{ from{ transform: translateX(-50%) translateY(6px); opacity:.0; } to{ transform: translateX(-50%) translateY(0); opacity:1; } }
    .toast .t{ font-weight: 900; color: var(--text); font-size: 15.5px; }
    .toast .d{ color: var(--muted); font-size: 13.5px; margin-top: 4px; line-height: 1.5; }

    .note{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(7,18,31,.25);
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.6;
    }

    .danger-text{ color: #ffb0b3; }
    .ok-text{ color: #a8f0b8; }
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="brand-left">
        <div class="mark">L</div>
        <div style="min-width:0">
          <h1>Laya shuttle bus</h1>
          <p class="sub" id="subtitle">กำลังเริ่มระบบ…</p>
        </div>
      </div>
      <nav class="nav" id="nav"></nav>
    </div>
  </header>

  <main class="wrap" id="view"></main>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="t" id="toastTitle"></div>
    <div class="d" id="toastDesc"></div>
  </div>

  <script type="module">
    // ============================
    // FIREBASE SETUP (กรอกค่าจาก Firebase Console > Project settings > Your apps)
    // ============================
        const firebaseConfig = {
          apiKey: "AIzaSyCql94D9FWgX4VIT5N1URKQDZ6IIyFGXys",
          authDomain: "shuttle-bus-dd8e0.firebaseapp.com",
          projectId: "shuttle-bus-dd8e0",
          storageBucket: "shuttle-bus-dd8e0.firebasestorage.app",
          messagingSenderId: "1097750801622",
          appId: "1:1097750801622:web:7ed78fca83999be34ced77",
          measurementId: "G-WTJP6RW7R8",
        };

    const FIREBASE_VERSION = "10.12.5"; // ใช้เป็นค่าอ้างอิงในคู่มือเท่านั้น (import ด้านล่างถูก fix ไว้)
    const FIREBASE_ENABLED = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY";

    // ============================
    // Imports (Firebase Modular SDK)
    // ============================
    let firebase = null;
    let db = null;
    let auth = null;
    let serverTimestamp = null;
    let runTransaction = null;
    let doc = null;
    let getDoc = null;
    let setDoc = null;
    let collection = null;
    let addDoc = null;
    let getDocs = null;
    let query = null;
    let where = null;
    let limit = null;
    let onSnapshot = null;
    let signInAnonymously = null;

    // ============================
    // APP CONFIG
    // ============================
    const CAPACITY_PER_TRIP = 20;

    // LocalStorage fallback keys
    const LS_STATE = "laya_bus_state_v_firebase";
    const LS_LOGS  = "laya_bus_logs_v_firebase";
    const LS_UI    = "laya_bus_ui_v_firebase";

    // Firestore paths
    const FS_STATE_COL = "shuttle_state";
    const FS_LOGS_COL  = "shuttle_logs";

    const DIRS = {
      out: {
        key: "out",
        label: "ขาไป",
        baseTimes: ["11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00"],
        timeline: [
          { key:"HOTEL",  name:"Hotel",              offset: 0 },
          { key:"LAYAN",  name:"Layan National Park",offset: 5 },
          { key:"LEPHANG",name:"Le Phang Beach",     offset: 10 },
          { key:"BOAT",   name:"Boat Avenue",        offset: 20 },
        ],
        selectLabel: "จุดหมายปลายทาง",
        selectable: [
          { key:"LAYAN",  name:"Layan National Park" },
          { key:"LEPHANG",name:"Le Phang Beach" },
          { key:"BOAT",   name:"Boat Avenue" },
        ]
      },
      back: {
        key: "back",
        label: "ขากลับ",
        baseTimes: ["11:30","12:30","13:30","14:30","15:30","16:30","17:30","18:30"],
        timeline: [
          { key:"BOAT",   name:"Boat Avenue",        offset: 0 },
          { key:"LEPHANG",name:"Le Phang Beach",     offset: 10 },
          { key:"LAYAN",  name:"Layan National Park",offset: 15 },
          { key:"HOTEL",  name:"Hotel",              offset: 20 },
        ],
        selectLabel: "จุดรับขึ้นรถ",
        selectable: [
          { key:"BOAT",   name:"Boat Avenue" },
          { key:"LEPHANG",name:"Le Phang Beach" },
          { key:"LAYAN",  name:"Layan National Park" },
        ]
      }
    };

    // ============================
    // Helpers
    // ============================
    const $ = (id) => document.getElementById(id);
    const pad2 = (n) => String(n).padStart(2, "0");
    const timeToMin = (t) => {
      const [h,m] = String(t).split(":").map(Number);
      return (h*60) + (m||0);
    };
    const minToTime = (min) => {
      const total = ((min % (24*60)) + (24*60)) % (24*60);
      const h = Math.floor(total/60);
      const m = total%60;
      return `${pad2(h)}:${pad2(m)}`;
    };
    const addMin = (t, d) => minToTime(timeToMin(t) + d);
    const nowMin = () => {
      const d = new Date();
      return d.getHours()*60 + d.getMinutes();
    };
    const todayKey = () => {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };
    const currentMonthKey = () => {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    };
    const isClosed = (baseTime) => nowMin() >= timeToMin(baseTime);
    const esc = (s) => String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

    function toast(title, desc=""){
      $("toastTitle").textContent = title;
      $("toastDesc").textContent = desc;
      const el = $("toast");
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>el.classList.remove("show"), 2600);
    }

    function parseHash(){
      const raw = (location.hash || "#/").replace(/^#/, "");
      const [path, qs=""] = raw.split("?");
      return { path: path || "/", params: new URLSearchParams(qs) };
    }
    const setHash = (path) => { location.hash = `#${path}`; };

    function downloadBlob(filename, mime, content){
      const blob = new Blob([content], { type: mime });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    const slotId = (dirKey, baseTime) => `${dirKey}|${baseTime}`;

    function buildDefaultState(dateKey){
      const slots = {};
      for (const dk of Object.keys(DIRS)){
        for (const t of DIRS[dk].baseTimes){
          const id = slotId(dk, t);
          slots[id] = { capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {} };
        }
      }
      return { version: 1, date: dateKey, slots };
    }

    function mergeStateWithDefault(dateKey, loaded){
      const base = buildDefaultState(dateKey);
      if(!loaded || loaded.date !== dateKey) return base;
      const merged = { version: 1, date: dateKey, slots: {} };
      for (const id of Object.keys(base.slots)){
        const s0 = base.slots[id];
        const s = (loaded.slots && loaded.slots[id]) ? loaded.slots[id] : s0;
        const cap = (typeof s.capacity === "number") ? s.capacity : CAPACITY_PER_TRIP;
        const avail = (typeof s.available === "number") ? s.available : cap;
        merged.slots[id] = {
          capacity: cap,
          available: Math.max(0, Math.min(cap, avail)),
          bookings: (s.bookings && typeof s.bookings === "object") ? s.bookings : {}
        };
      }
      return merged;
    }

    // ============================
    // Backend: LocalStorage
    // ============================
    const LocalBackend = {
      mode: "local",
      async init(){
        $("subtitle").textContent = "โหมด Local: ข้อมูลที่นั่ง + Log อยู่ในเครื่องนี้ (Export เป็น Excel ได้)";
        return true;
      },
      getUi(){
        try{
          const raw = localStorage.getItem(LS_UI);
          if(!raw) return { dir: "out" };
          const parsed = JSON.parse(raw);
          return { dir: (parsed && parsed.dir === "back") ? "back" : "out" };
        }catch{ return { dir:"out" }; }
      },
      setUi(ui){ localStorage.setItem(LS_UI, JSON.stringify(ui)); },

      getState(dateKey){
        try{
          const raw = localStorage.getItem(LS_STATE);
          if(!raw) return buildDefaultState(dateKey);
          const parsed = JSON.parse(raw);
          return mergeStateWithDefault(dateKey, parsed);
        }catch{
          return buildDefaultState(dateKey);
        }
      },
      async resetState(dateKey){
        const st = buildDefaultState(dateKey);
        localStorage.setItem(LS_STATE, JSON.stringify(st));
        return st;
      },
      async transactBook(dateKey, sId, room, pax, meta){
        const st = this.getState(dateKey);
        const slot = st.slots[sId];
        if(!slot) return { ok:false, msg:"ไม่พบรอบเวลานี้" };
        const existing = slot.bookings?.[room];
        if(existing && existing.pax > 0) return { ok:false, msg:`ห้องนี้จองแล้ว ${existing.pax} คน (กันการกดซ้ำ)` };
        if(pax > slot.available) return { ok:false, msg:"ที่นั่งไม่พอสำหรับจำนวนคนที่เลือก" };
        slot.available -= pax;
        slot.bookings[room] = { pax, ...meta };
        localStorage.setItem(LS_STATE, JSON.stringify(st));
        await this.addLog({
          tsISO: new Date().toISOString(),
          date: dateKey,
          month: dateKey.slice(0,7),
          action: "BOOK",
          slotId: sId,
          ...meta,
          room, pax
        });
        return { ok:true, state: st };
      },
      async transactCancel(dateKey, sId, room, pax){
        const st = this.getState(dateKey);
        const slot = st.slots[sId];
        if(!slot) return { ok:false, msg:"ไม่พบรอบเวลานี้" };
        const existing = slot.bookings?.[room];
        const booked = existing ? (existing.pax || 0) : 0;
        if(booked <= 0) return { ok:false, msg:"เลขห้องนี้ยังไม่มีการจองในรอบนี้" };
        if(pax > booked) return { ok:false, msg:`ยกเลิกเกินจำนวนที่จองไว้ (จองไว้ ${booked} คน)` };
        const left = booked - pax;
        if(left === 0) delete slot.bookings[room];
        else slot.bookings[room].pax = left;
        slot.available = Math.min(slot.capacity, slot.available + pax);
        localStorage.setItem(LS_STATE, JSON.stringify(st));
        await this.addLog({
          tsISO: new Date().toISOString(),
          date: dateKey,
          month: dateKey.slice(0,7),
          action: "CANCEL",
          slotId: sId,
          dir: existing?.dir || "",
          roundBase: existing?.roundBase || "",
          pickup: existing?.pickup || "",
          destination: existing?.destination || "",
          pickupTime: existing?.pickupTime || "",
          arriveTime: existing?.arriveTime || "",
          placeKey: existing?.placeKey || "",
          room, pax
        });
        return { ok:true, state: st };
      },
      loadLogs(){
        try{
          const raw = localStorage.getItem(LS_LOGS);
          if(!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        }catch{ return []; }
      },
      async addLog(entry){
        const logs = this.loadLogs();
        logs.unshift(entry);
        localStorage.setItem(LS_LOGS, JSON.stringify(logs));
      },
      async fetchLogs({ mode, value }){
        const logs = this.loadLogs();
        let filtered = logs;
        if(mode === "day"){
          const day = value || todayKey();
          filtered = logs.filter(e => (e?.date || "") === day);
        }else if(mode === "month"){
          const mk = value || currentMonthKey();
          filtered = logs.filter(e => (e?.month || (e?.date||"").slice(0,7)) === mk);
        }
        // sort desc by tsISO
        filtered.sort((a,b)=> String(b?.tsISO||"").localeCompare(String(a?.tsISO||"")));
        return filtered;
      }
    };

    // ============================
    // Backend: Firebase / Firestore
    // ============================
    const FirebaseBackend = {
      mode: "firebase",
      _stateCache: null,
      _stateDate: null,
      _unsubState: null,

      async init(){
        if(!FIREBASE_ENABLED){
          $("subtitle").textContent = "โหมด Local: (ยังไม่ได้ตั้งค่า Firebase) • ใส่ firebaseConfig ใน index.html เพื่อใช้ Realtime";
          return false;
        }

        // dynamic import (keeps page working even if user doesn't configure firebase)
        const appMod = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
        const fsMod  = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");
        const auMod  = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");

        firebase = appMod;
        serverTimestamp = fsMod.serverTimestamp;
        runTransaction = fsMod.runTransaction;
        doc = fsMod.doc;
        getDoc = fsMod.getDoc;
        setDoc = fsMod.setDoc;
        collection = fsMod.collection;
        addDoc = fsMod.addDoc;
        getDocs = fsMod.getDocs;
        query = fsMod.query;
        where = fsMod.where;
        limit = fsMod.limit;
        onSnapshot = fsMod.onSnapshot;

        signInAnonymously = auMod.signInAnonymously;

        const app = appMod.initializeApp(firebaseConfig);
        db = fsMod.getFirestore(app);
        auth = auMod.getAuth(app);

        // Sign-in anonymously (requires enabling Anonymous in Firebase Auth)
        try{
          await signInAnonymously(auth);
        }catch(e){
          // Most common: unauthorized-domain (need to add github.io domain)
          console.error(e);
          $("subtitle").textContent = "Firebase: เข้าสู่ระบบไม่สำเร็จ (เช็ก Authorized domains / เปิด Anonymous Auth)";
          toast("Firebase Auth Error", e?.message || String(e));
          return false;
        }

        $("subtitle").textContent = "โหมด Firebase (Realtime): ที่นั่ง + Log ใช้ร่วมกันทุกเครื่อง (Export เป็น Excel ได้)";
        return true;
      },

      getUi(){
        // store UI choice locally (fine)
        try{
          const raw = localStorage.getItem(LS_UI);
          if(!raw) return { dir: "out" };
          const parsed = JSON.parse(raw);
          return { dir: (parsed && parsed.dir === "back") ? "back" : "out" };
        }catch{ return { dir:"out" }; }
      },
      setUi(ui){ localStorage.setItem(LS_UI, JSON.stringify(ui)); },

      async _ensureState(dateKey){
        const ref = doc(db, FS_STATE_COL, dateKey);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          const base = buildDefaultState(dateKey);
          await setDoc(ref, base, { merge: false });
          return base;
        }
        return mergeStateWithDefault(dateKey, snap.data());
      },

      async _listenState(dateKey, onChange){
        if(this._unsubState){ try{ this._unsubState(); }catch{} this._unsubState = null; }
        const ref = doc(db, FS_STATE_COL, dateKey);
        this._unsubState = onSnapshot(ref, (snap)=>{
          if(!snap.exists()){
            const base = buildDefaultState(dateKey);
            this._stateCache = base;
            this._stateDate = dateKey;
            onChange?.(base);
            return;
          }
          const st = mergeStateWithDefault(dateKey, snap.data());
          this._stateCache = st;
          this._stateDate = dateKey;
          onChange?.(st);
        }, (err)=>{
          console.error(err);
          toast("Firebase Error", err?.message || String(err));
        });
      },

      async getState(dateKey){
        if(this._stateCache && this._stateDate === dateKey) return this._stateCache;
        const st = await this._ensureState(dateKey);
        this._stateCache = st;
        this._stateDate = dateKey;
        return st;
      },

      async resetState(dateKey){
        const ref = doc(db, FS_STATE_COL, dateKey);
        const base = buildDefaultState(dateKey);
        await setDoc(ref, base, { merge:false });
        this._stateCache = base;
        this._stateDate = dateKey;
        return base;
      },

      async transactBook(dateKey, sId, room, pax, meta){
        const ref = doc(db, FS_STATE_COL, dateKey);

        try{
          await runTransaction(db, async (tx)=>{
            const snap = await tx.get(ref);
            let st = snap.exists() ? snap.data() : buildDefaultState(dateKey);
            st = mergeStateWithDefault(dateKey, st);
            const slot = st.slots[sId];
            if(!slot) throw new Error("NOT_FOUND");
            const existing = slot.bookings?.[room];
            if(existing && existing.pax > 0) throw new Error("ALREADY");
            if(pax > slot.available) throw new Error("NOSEATS");
            slot.available -= pax;
            slot.bookings[room] = { pax, ...meta };
            tx.set(ref, st, { merge:false });
          });
        }catch(e){
          const msg = (e?.message === "ALREADY") ? "ห้องนี้จองแล้ว (กันการกดซ้ำ)" :
                      (e?.message === "NOSEATS") ? "ที่นั่งไม่พอสำหรับจำนวนคนที่เลือก" :
                      (e?.message === "NOT_FOUND") ? "ไม่พบรอบเวลานี้" :
                      (e?.message || "จองไม่สำเร็จ");
          return { ok:false, msg };
        }

        // Add log AFTER transaction (avoid duplicates on retry)
        await this.addLog({
          tsISO: new Date().toISOString(),
          date: dateKey,
          month: dateKey.slice(0,7),
          action: "BOOK",
          slotId: sId,
          ...meta,
          room, pax
        });

        const st2 = await this.getState(dateKey);
        return { ok:true, state: st2 };
      },

      async transactCancel(dateKey, sId, room, pax){
        const ref = doc(db, FS_STATE_COL, dateKey);
        let existingMeta = null;

        try{
          await runTransaction(db, async (tx)=>{
            const snap = await tx.get(ref);
            let st = snap.exists() ? snap.data() : buildDefaultState(dateKey);
            st = mergeStateWithDefault(dateKey, st);
            const slot = st.slots[sId];
            if(!slot) throw new Error("NOT_FOUND");
            const existing = slot.bookings?.[room];
            const booked = existing ? (existing.pax || 0) : 0;
            if(booked <= 0) throw new Error("NOBK");
            if(pax > booked) throw new Error("TOO_MUCH");

            existingMeta = existing;

            const left = booked - pax;
            if(left === 0) delete slot.bookings[room];
            else slot.bookings[room].pax = left;

            slot.available = Math.min(slot.capacity, slot.available + pax);
            tx.set(ref, st, { merge:false });
          });
        }catch(e){
          const msg = (e?.message === "NOT_FOUND") ? "ไม่พบรอบเวลานี้" :
                      (e?.message === "NOBK") ? "เลขห้องนี้ยังไม่มีการจองในรอบนี้" :
                      (e?.message === "TOO_MUCH") ? "ยกเลิกเกินจำนวนที่จองไว้" :
                      (e?.message || "ยกเลิกไม่สำเร็จ");
          return { ok:false, msg };
        }

        await this.addLog({
          tsISO: new Date().toISOString(),
          date: dateKey,
          month: dateKey.slice(0,7),
          action: "CANCEL",
          slotId: sId,
          dir: existingMeta?.dir || "",
          roundBase: existingMeta?.roundBase || "",
          pickup: existingMeta?.pickup || "",
          destination: existingMeta?.destination || "",
          pickupTime: existingMeta?.pickupTime || "",
          arriveTime: existingMeta?.arriveTime || "",
          placeKey: existingMeta?.placeKey || "",
          room, pax
        });

        const st2 = await this.getState(dateKey);
        return { ok:true, state: st2 };
      },

      async addLog(entry){
        // Keep fields simple (avoid needing composite indexes)
        const ref = collection(db, FS_LOGS_COL);
        await addDoc(ref, {
          ...entry,
          // Optional server timestamp (not used for querying here)
          ts: serverTimestamp ? serverTimestamp() : null,
        });
      },

      async fetchLogs({ mode, value }){
        const ref = collection(db, FS_LOGS_COL);
        let q = null;
        if(mode === "day"){
          const day = value || todayKey();
          q = query(ref, where("date", "==", day), limit(5000));
        }else if(mode === "month"){
          const mk = value || currentMonthKey();
          q = query(ref, where("month", "==", mk), limit(5000));
        }else{
          // all
          q = query(ref, limit(5000));
        }
        const snap = await getDocs(q);
        const logs = snap.docs.map(d => d.data());
        // sort desc by tsISO
        logs.sort((a,b)=> String(b?.tsISO||"").localeCompare(String(a?.tsISO||"")));
        return logs;
      }
    };

    // Decide backend
    const backend = (FIREBASE_ENABLED) ? FirebaseBackend : LocalBackend;
    let firebaseReady = false;

    // ============================
    // Excel export
    // ============================
    function buildExcelHtml(logs){
      const rows = logs.map((e)=>{
        const ts = e?.tsISO ? new Date(e.tsISO).toLocaleString() : "";
        const action = e?.action || "";
        const dir = e?.dir === "out" ? "ขาไป" : (e?.dir === "back" ? "ขากลับ" : (e?.dir || ""));
        const roundBase = e?.roundBase || "";
        const pickup = e?.pickup || "";
        const destination = e?.destination || "";
        const pickupTime = e?.pickupTime || "";
        const arriveTime = e?.arriveTime || "";
        const room = e?.room || "";
        const pax = (typeof e?.pax === "number") ? e.pax : "";
        const date = e?.date || "";
        return `
<tr>
  <td>${esc(ts)}</td>
  <td>${esc(date)}</td>
  <td>${esc(action)}</td>
  <td>${esc(dir)}</td>
  <td>${esc(roundBase)}</td>
  <td>${esc(pickup)}</td>
  <td>${esc(destination)}</td>
  <td>${esc(pickupTime)}</td>
  <td>${esc(arriveTime)}</td>
  <td>${esc(room)}</td>
  <td>${esc(pax)}</td>
</tr>`;
      }).join("\n");

      return `<!doctype html>
<html>
<head><meta charset="UTF-8" /></head>
<body>
<table border="1">
<thead>
<tr>
<th>Timestamp</th>
<th>Date</th>
<th>Action</th>
<th>Direction</th>
<th>Round</th>
<th>Pickup</th>
<th>Destination</th>
<th>Pickup time</th>
<th>Arrival time</th>
<th>Room</th>
<th>Pax</th>
</tr>
</thead>
<tbody>
${rows}
</tbody>
</table>
</body>
</html>`;
    }

    async function exportExcel(mode){
      const date = todayKey();
      const month = currentMonthKey();
      let value = "";
      let suffix = `all-${date}`;
      if(mode === "day"){ value = date; suffix = date; }
      if(mode === "month"){ value = month; suffix = month; }
      const logs = await backend.fetchLogs({ mode, value });
      const html = buildExcelHtml(logs);
      const fname = `laya-shuttle-logs-${suffix}.xls`;
      downloadBlob(fname, "application/vnd.ms-excel;charset=utf-8", "\ufeff" + html);
      toast("Export สำเร็จ", `จำนวน ${logs.length} รายการ • ${mode === "day" ? "วันนี้" : (mode === "month" ? "เดือนนี้" : "ทั้งหมด")}`);
    }

    // ============================
    // UI: Nav
    // ============================
    function renderNav(active){
      const nav = $("nav");
      nav.innerHTML = "";
      const items = [
        { key:"/", label:"ตารางเวลา", href:"#/" },
        { key:"/logs", label:"บันทึก/สถิติ", href:"#/logs" },
      ];
      for(const it of items){
        const a = document.createElement("a");
        a.href = it.href;
        a.className = `chip ${active===it.key ? "active" : ""}`;
        a.textContent = it.label;
        nav.appendChild(a);
      }
    }

    // ============================
    // View: Schedule (no log stats on home)
    // ============================
    async function viewSchedule(){
      renderNav("/");
      const ui = backend.getUi();
      const date = todayKey();

      // ensure realtime listener for firebase
      if(backend === FirebaseBackend && firebaseReady){
        await backend.getState(date);
        await backend._listenState(date, () => {
          // rerender only if we are still on home
          const { path } = parseHash();
          if(path === "/") viewSchedule().catch(console.error);
        });
      }

      const st = await backend.getState(date);
      const dirKey = ui.dir;
      const dir = DIRS[dirKey];

      const cards = dir.baseTimes.map((t)=>{
        const id = slotId(dirKey, t);
        const s = st.slots[id];
        const closed = isClosed(t);
        const btnLabel = closed ? "ปิดแล้ว" : "เลือก";
        const btnKind = closed ? "primary" : "pick";
        const availClass = (s.available===0) ? "danger" : "";
        return `
<div class="slot">
  <div class="meta">
    <div class="time">${esc(t)}</div>
    <div class="seat">ที่นั่งว่าง: <b class="${availClass}">${s.available}</b> / ${s.capacity}${closed ? ' • <span class="danger-text">ปิดทำรายการ</span>' : ""}</div>
  </div>
  <button class="btn ${btnKind}" ${(closed || s.available===0) ? "disabled" : ""} onclick="window.__openBooking('${dirKey}','${t}')">${btnLabel}</button>
</div>`;
      }).join("\n");

      const modeBadge = (backend.mode === "firebase" && firebaseReady)
        ? `<span class="badge"><span class="dot ok"></span> Firebase Realtime</span>`
        : `<span class="badge"><span class="dot"></span> Local</span>`;

      const rightInfo = (backend.mode === "firebase" && !firebaseReady)
        ? `<div class="note"><b class="danger-text">ยังไม่พร้อมใช้งาน Firebase</b><br/>กรุณากรอก firebaseConfig และตั้งค่า Authorized domains / Anonymous Auth ตามคู่มือ</div>`
        : `<div class="note">Export สามารถเลือกได้: <b>วันนี้ / เดือนนี้ / ทั้งหมด</b><br/>แนะนำ Export เดือนละครั้งเพื่อสรุปสถิติ</div>`;

      $("view").innerHTML = `
<div class="grid">
  <section class="card">
    <div class="card-h">
      <div>
        <h2>ตารางเวลาเดินรถ</h2>
        <p class="hint">เลือก <b>ขาไป/ขากลับ</b> แล้วกด “เลือก” เพื่อไปหน้าเลือกปลายทาง/จุดรับ</p>
      </div>
      <div class="row">
        ${modeBadge}
        <button class="chip ${dirKey==="out"?"active":""}" onclick="window.__setDir('out')">ขาไป</button>
        <button class="chip ${dirKey==="back"?"active":""}" onclick="window.__setDir('back')">ขากลับ</button>
      </div>
    </div>
    <div class="card-b">
      <div class="slots">${cards}</div>
      <div class="mini"><b>Daily reset:</b> ที่นั่งรีเซ็ตทุกวัน • <b>Past time:</b> รอบที่ปิดแล้วจอง/ยกเลิกไม่ได้</div>
    </div>
  </section>

  <aside class="card">
    <div class="card-h">
      <div>
        <h2>Export Log</h2>
        <p class="hint">Export เป็นไฟล์ Excel (.xls) ตามช่วงที่ต้องการ</p>
      </div>
    </div>
    <div class="card-b">
      <div class="row" style="justify-content:flex-end">
        <button class="btn" onclick="window.__exportDay()">Export วันนี้</button>
        <button class="btn" onclick="window.__exportMonth()">Export เดือนนี้</button>
        <button class="btn" onclick="window.__exportAll()">Export ทั้งหมด</button>
      </div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn danger" onclick="window.__resetSeats()">รีเซ็ตที่นั่ง (วันนี้)</button>
      </div>
      ${rightInfo}
    </div>
  </aside>
</div>`;

      window.__setDir = (d)=>{
        backend.setUi({ dir: (d==="back") ? "back" : "out" });
        viewSchedule().catch(console.error);
      };

      window.__openBooking = (d,t)=>{
        setHash(`/book?dir=${encodeURIComponent(d)}&time=${encodeURIComponent(t)}`);
      };

      window.__exportDay = ()=> exportExcel("day").catch(e=>toast("Export ไม่สำเร็จ", e?.message||String(e)));
      window.__exportMonth = ()=> exportExcel("month").catch(e=>toast("Export ไม่สำเร็จ", e?.message||String(e)));
      window.__exportAll = ()=> exportExcel("all").catch(e=>toast("Export ไม่สำเร็จ", e?.message||String(e)));

      window.__resetSeats = async ()=>{
        if(!confirm("ต้องการรีเซ็ตที่นั่งของวันนี้ (ไม่ลบ Log) ใช่ไหม?")) return;
        await backend.resetState(date);
        toast("รีเซ็ตที่นั่งแล้ว", `วันที่ ${date}`);
        viewSchedule().catch(console.error);
      };
    }

    // ============================
    // View: Booking
    // ============================
    async function viewBooking(dirKey, baseTime){
      renderNav("/");
      const date = todayKey();
      const dir = (dirKey === "back") ? DIRS.back : DIRS.out;

      if(isClosed(baseTime)){
        toast("ปิดทำรายการแล้ว", "รอบนี้ไม่สามารถจอง/ยกเลิกได้");
      }

      // ensure state + listen
      if(backend === FirebaseBackend && firebaseReady){
        await backend.getState(date);
        await backend._listenState(date, () => {
          const { path, params } = parseHash();
          if(path === "/book"){
            const d = params.get("dir") || "out";
            const t = params.get("time") || "";
            if(t === baseTime && d === dirKey){
              viewBooking(dirKey, baseTime).catch(console.error);
            }
          }
        });
      }

      const st = await backend.getState(date);
      const sId = slotId(dir.key, baseTime);
      const slot = st.slots[sId];
      if(!slot){
        toast("ไม่พบรอบเวลา", "กลับไปเลือกใหม่");
        setHash("/");
        return;
      }

      const options = dir.selectable.map(p=>`<option value="${esc(p.key)}">${esc(p.name)}</option>`).join("");

      $("view").innerHTML = `
<section class="card">
  <div class="card-h">
    <div>
      <h2>${esc(dir.label)} • รอบเวลา <span style="color:var(--gold2)">${esc(baseTime)}</span></h2>
      <p class="hint">เลือก ${esc(dir.selectLabel)} ก่อน แล้วระบบจะแสดงเวลาถึง</p>
    </div>
    <div class="row">
      <button class="btn" onclick="window.__back()">ย้อนกลับ</button>
    </div>
  </div>

  <div class="card-b" style="max-width: 860px;">
    <div class="row" style="gap: 12px;">
      <div class="field" style="flex: 1 1 360px;">
        <label for="place">${esc(dir.selectLabel)}</label>
        <select id="place">
          <option value="">— โปรดเลือก —</option>
          ${options}
        </select>
      </div>
      <div class="field" style="flex: 1 1 260px;">
        <label>เวลาถึงโดยประมาณ</label>
        <input id="arrival" readonly value="—" />
      </div>
    </div>

    <div class="note" id="routeNote">เลือก ${esc(dir.selectLabel)} เพื่อคำนวณเวลา</div>

    <div class="divider"></div>

    <div class="row" style="gap: 12px;">
      <div class="field" style="flex: 1 1 260px;">
        <label for="room">เลขห้อง</label>
        <input id="room" autocomplete="off" placeholder="เช่น A105" />
      </div>
      <div class="field" style="flex: 0 0 240px;">
        <label for="pax">จำนวนคน</label>
        <input id="pax" type="number" min="1" step="1" inputmode="numeric" placeholder="เช่น 2" />
      </div>
    </div>

    <div style="height: 12px"></div>

    <div class="row">
      <button id="btnBook" class="btn primary" onclick="window.__book()">จอง</button>
      <button class="btn danger" onclick="window.__cancel()">ยกเลิกการจอง</button>
      <span class="badge"><span class="dot"></span> 1 ห้อง/1 รอบ จองได้ครั้งเดียว</span>
    </div>

    <div class="mini" id="mini"></div>
    <div class="note" id="note"></div>

    <div class="divider"></div>

    <div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14);">
      <div class="card-h" style="border-bottom-color: rgba(131,106,69,.10)">
        <div>
          <h2 style="font-size: 15.5px;">รายการจองในรอบนี้</h2>
          <p class="hint">แสดงเลขห้อง/จำนวนคน/เส้นทาง/เวลาถึง</p>
        </div>
      </div>
      <div class="card-b" id="bookingsTable"></div>
    </div>
  </div>
</section>`;

      const placeEl = $("place");
      const arrivalEl = $("arrival");
      const routeNoteEl = $("routeNote");
      const roomEl = $("room");
      const paxEl = $("pax");
      const bookBtn = $("btnBook");
      const noteEl = $("note");

      const updateMini = async ()=>{
        const st2 = await backend.getState(date);
        const sl = st2.slots[sId];
        const closedNow = isClosed(baseTime);
        const bClass = sl.available===0 ? "danger" : "";
        $("mini").innerHTML = `<b>คงเหลือ:</b> ที่นั่งว่าง <b class="${bClass}">${sl.available}</b> / ${sl.capacity}${closedNow ? ' • <span class="danger-text"><b>ปิดทำรายการแล้ว</b></span>' : ''}<br/><span style="color:var(--muted)">Tip: หากต้องการเปลี่ยนจำนวนหรือเปลี่ยนจุด ให้ยกเลิกจนเหลือ 0 แล้วจองใหม่</span>`;

        if(closedNow){
          bookBtn.disabled = true;
          placeEl.disabled = true;
          roomEl.disabled = true;
          paxEl.disabled = true;
        }
      };

      const updateArrivalPreview = ()=>{
        const placeKey = placeEl.value;
        const times = calcTimes(dir.key, baseTime, placeKey);
        if(!times){
          arrivalEl.value = "—";
          routeNoteEl.textContent = `เลือก ${dir.selectLabel} เพื่อคำนวณเวลา`;
          return;
        }
        if(dir.key === "out"){
          arrivalEl.value = `ถึง ${times.destination} ${times.arriveTime}`;
          routeNoteEl.innerHTML = `ออกจาก <b>${esc(times.pickup)}</b> เวลา <b>${esc(times.pickupTime)}</b> • ถึง <b>${esc(times.destination)}</b> เวลา <b>${esc(times.arriveTime)}</b>`;
        }else{
          arrivalEl.value = `ถึง Hotel ${times.arriveTime}`;
          routeNoteEl.innerHTML = `รับที่ <b>${esc(times.pickup)}</b> เวลา <b>${esc(times.pickupTime)}</b> • ถึง <b>Hotel</b> เวลา <b>${esc(times.arriveTime)}</b>`;
        }
      };

      const updateBookBtn = async ()=>{
        const st2 = await backend.getState(date);
        const sl = st2.slots[sId];
        const room = (roomEl.value || "").trim();
        const existing = room ? sl.bookings?.[room] : null;
        const booked = existing ? (existing.pax || 0) : 0;

        if(room && booked > 0){
          bookBtn.disabled = true;
          const placeText = (existing.pickup && existing.destination) ? `${existing.pickup} → ${existing.destination}` : "";
          noteEl.innerHTML = `ห้อง <b>${esc(room)}</b> จองแล้ว <b>${booked}</b> คนในรอบนี้${placeText ? ` (${esc(placeText)})` : ""} — กันการกดซ้ำ`;
        }else{
          if(!isClosed(baseTime)) bookBtn.disabled = false;
          noteEl.textContent = "";
        }
      };

      const renderBookingsTable = async ()=>{
        const st2 = await backend.getState(date);
        const sl = st2.slots[sId];
        const entries = Object.entries(sl.bookings || {}).sort((a,b)=>a[0].localeCompare(b[0]));
        const wrap = $("bookingsTable");
        if(entries.length === 0){
          wrap.innerHTML = `<div class="mini">ยังไม่มีการจองในรอบนี้</div>`;
          return;
        }
        const rows = entries.map(([room,obj])=>{
          const pax = obj?.pax ?? "";
          const line = (obj?.pickup && obj?.destination) ? `${obj.pickup} → ${obj.destination}` : "";
          const arrive = obj?.arriveTime ? `ถึง ${obj.arriveTime}` : "";
          return `<tr><td>${esc(room)}</td><td><b>${esc(pax)}</b></td><td>${esc(line)}</td><td>${esc(arrive)}</td></tr>`;
        }).join("");
        wrap.innerHTML = `<table><thead><tr><th>เลขห้อง</th><th>จำนวนคน</th><th>เส้นทาง</th><th>เวลาถึง</th></tr></thead><tbody>${rows}</tbody></table>`;
      };

      const refresh = async ()=>{
        await updateMini();
        updateArrivalPreview();
        await updateBookBtn();
        await renderBookingsTable();
      };

      placeEl.addEventListener("change", ()=>refresh().catch(console.error));
      roomEl.addEventListener("input", ()=>refresh().catch(console.error));

      window.__back = ()=> setHash("/");

      window.__book = async ()=>{
        if(isClosed(baseTime)){ toast("ปิดทำรายการแล้ว","รอบนี้ไม่สามารถจองได้"); return; }
        const placeKey = (placeEl.value || "").trim();
        const room = (roomEl.value || "").trim();
        const pax = Number.parseInt(paxEl.value, 10);

        if(!placeKey){ toast("ข้อมูลไม่ครบ", `กรุณาเลือก ${dir.selectLabel}`); return; }
        if(!room){ toast("ข้อมูลไม่ครบ", "กรุณาใส่เลขห้อง"); return; }
        if(!Number.isFinite(pax) || pax <= 0){ toast("ข้อมูลไม่ครบ", "กรุณาใส่จำนวนคน"); return; }

        const times = calcTimes(dir.key, baseTime, placeKey);
        if(!times){ toast("ข้อมูลไม่ถูกต้อง", "ไม่สามารถคำนวณเวลาได้"); return; }

        bookBtn.disabled = true;

        const res = await backend.transactBook(date, sId, room, pax, {
          dir: dir.key,
          roundBase: baseTime,
          pickup: times.pickup,
          destination: times.destination,
          pickupTime: times.pickupTime,
          arriveTime: times.arriveTime,
          placeKey
        });

        if(!res.ok){ toast("จองไม่สำเร็จ", res.msg); await refresh(); return; }

        toast("จองสำเร็จ", `${dir.label} • ห้อง ${room} • ${pax} คน • ถึง ${times.arriveTime}`);
        await refresh();
      };

      window.__cancel = async ()=>{
        if(isClosed(baseTime)){ toast("ปิดทำรายการแล้ว","รอบนี้ไม่สามารถยกเลิกได้"); return; }
        const room = (roomEl.value || "").trim();
        const pax = Number.parseInt(paxEl.value, 10);
        if(!room){ toast("ข้อมูลไม่ครบ","กรุณาใส่เลขห้อง"); return; }
        if(!Number.isFinite(pax) || pax <= 0){ toast("ข้อมูลไม่ครบ","กรุณาใส่จำนวนคน"); return; }

        const res = await backend.transactCancel(date, sId, room, pax);
        if(!res.ok){ toast("ยกเลิกไม่สำเร็จ", res.msg); await refresh(); return; }

        toast("ยกเลิกสำเร็จ", `คืนที่นั่ง ${pax} คน • ห้อง ${room}`);
        await refresh();
      };

      await refresh();
    }

    // ============================
    // View: Logs + Export picker
    // ============================
    function sumByRound(logs, dirKey){
      const per = {};
      for(const t of DIRS[dirKey].baseTimes) per[t] = 0;
      for(const e of logs){
        if(e?.action !== "BOOK") continue;
        if(e?.dir !== dirKey) continue;
        const rb = e?.roundBase;
        if(rb) per[rb] = (per[rb] || 0) + (typeof e?.pax === "number" ? e.pax : 0);
      }
      const top = Object.entries(per).sort((a,b)=>b[1]-a[1])[0];
      return { per, topTime: top?.[0] || "—", topValue: top?.[1] || 0 };
    }

    async function viewLogs(){
      renderNav("/logs");
      const monthKey = currentMonthKey();
      const logsMonth = await backend.fetchLogs({ mode:"month", value: monthKey });

      const outStats = sumByRound(logsMonth, "out");
      const backStats = sumByRound(logsMonth, "back");

      const barsFor = (stats)=>{
        const maxVal = Math.max(...Object.values(stats.per));
        return Object.entries(stats.per).sort((a,b)=>a[0].localeCompare(b[0])).map(([t,v])=>{
          const w = maxVal ? Math.round((v/maxVal)*100) : 0;
          return `
<div class="slot" style="padding:10px 12px;">
  <div class="meta" style="gap:4px;">
    <div style="font-weight:900; color: var(--muted)">${esc(t)}</div>
    <div class="seat" style="font-size:13px;"><span style="display:inline-block; width: 210px; height:12px; background: rgba(131,106,69,.10); border-radius: 999px; overflow:hidden; vertical-align:middle;">
      <span style="display:block; width:${w}%; height:100%; background: linear-gradient(90deg, rgba(131,106,69,.60), rgba(176,163,144,.22));"></span>
    </span> <b style="color:var(--gold2); font-size:13px;">${v}</b></div>
  </div>
</div>`;
        }).join("\n");
      };

      const recent = logsMonth.slice(0, 250);
      const rows = recent.map((e)=>{
        const ts = e?.tsISO ? new Date(e.tsISO).toLocaleString() : "";
        const action = e?.action === "BOOK"
          ? `<span style="color:var(--ok);font-weight:900">BOOK</span>`
          : `<span style="color:var(--danger);font-weight:900">CANCEL</span>`;
        const dir = e?.dir === "out" ? "ขาไป" : (e?.dir === "back" ? "ขากลับ" : (e?.dir || ""));
        const route = (e?.pickup && e?.destination) ? `${e.pickup} → ${e.destination}` : "";
        return `
<tr>
  <td>${esc(ts)}</td>
  <td>${action}</td>
  <td>${esc(dir)}</td>
  <td>${esc(e?.roundBase || "")}</td>
  <td>${esc(route)}</td>
  <td>${esc(e?.arriveTime || "")}</td>
  <td>${esc(e?.room || "")}</td>
  <td><b>${esc(typeof e?.pax === "number" ? e.pax : "")}</b></td>
</tr>`;
      }).join("\n");

      $("view").innerHTML = `
<section class="card">
  <div class="card-h">
    <div>
      <h2>บันทึก/สถิติ</h2>
      <p class="hint">เดือน <b>${esc(monthKey)}</b> • Export ได้ทั้ง “วัน / เดือน / ทั้งหมด” • แสดง Log ล่าสุด 250 รายการ</p>
    </div>
    <div class="row">
      <button class="btn primary" onclick="window.__goSchedule()">กลับหน้าตาราง</button>
    </div>
  </div>

  <div class="card-b">
    <div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14); margin-bottom: 12px;">
      <div class="card-b">
        <div class="row" style="align-items:flex-end; justify-content:space-between">
          <div class="row" style="flex:1;">
            <div class="field" style="max-width: 230px;">
              <label for="expDay">Export ตามวัน</label>
              <input id="expDay" type="date" />
            </div>
            <button class="btn" onclick="window.__exportDayPicked()">Export วัน</button>

            <div class="field" style="max-width: 230px;">
              <label for="expMonth">Export ตามเดือน</label>
              <input id="expMonth" type="month" />
            </div>
            <button class="btn" onclick="window.__exportMonthPicked()">Export เดือน</button>
          </div>
          <div class="row">
            <button class="btn" onclick="window.__exportAll()">Export ทั้งหมด</button>
          </div>
        </div>
        <div class="mini">หมายเหตุ: Export วัน = เฉพาะวันที่เลือก • Export เดือน = เฉพาะเดือนที่เลือก</div>
      </div>
    </div>

    <div class="grid">
      <div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14);">
        <div class="card-h" style="border-bottom-color: rgba(131,106,69,.10)">
          <div>
            <h2 style="font-size: 15.5px;">สถิติ • ขาไป</h2>
            <p class="hint">เวลาที่จองเยอะสุด: <b>${esc(outStats.topTime)}</b> (${outStats.topValue} คน)</p>
          </div>
        </div>
        <div class="card-b">${barsFor(outStats)}</div>
      </div>

      <div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14);">
        <div class="card-h" style="border-bottom-color: rgba(131,106,69,.10)">
          <div>
            <h2 style="font-size: 15.5px;">สถิติ • ขากลับ</h2>
            <p class="hint">เวลาที่จองเยอะสุด: <b>${esc(backStats.topTime)}</b> (${backStats.topValue} คน)</p>
          </div>
        </div>
        <div class="card-b">${barsFor(backStats)}</div>
      </div>
    </div>

    <div class="divider"></div>

    <table>
      <thead>
        <tr>
          <th>เวลา</th>
          <th>Action</th>
          <th>ขา</th>
          <th>รอบ</th>
          <th>เส้นทาง</th>
          <th>ถึง</th>
          <th>ห้อง</th>
          <th>คน</th>
        </tr>
      </thead>
      <tbody>
        ${rows || `<tr><td colspan="8" class="mini">ยังไม่มี Log</td></tr>`}
      </tbody>
    </table>

    <div class="mini">Log เดือนนี้: ${logsMonth.length} รายการ</div>
  </div>
</section>`;

      const dayEl = $("expDay");
      const monthEl = $("expMonth");
      dayEl.value = todayKey();
      monthEl.value = currentMonthKey();

      window.__goSchedule = ()=> setHash("/");

      window.__exportDayPicked = async ()=>{
        const day = dayEl.value || todayKey();
        const logs = await backend.fetchLogs({ mode:"day", value: day });
        const html = buildExcelHtml(logs);
        downloadBlob(`laya-shuttle-logs-${day}.xls`, "application/vnd.ms-excel;charset=utf-8", "\ufeff" + html);
        toast("Export สำเร็จ", `วัน ${day} • ${logs.length} รายการ`);
      };

      window.__exportMonthPicked = async ()=>{
        const mk = monthEl.value || currentMonthKey();
        const logs = await backend.fetchLogs({ mode:"month", value: mk });
        const html = buildExcelHtml(logs);
        downloadBlob(`laya-shuttle-logs-${mk}.xls`, "application/vnd.ms-excel;charset=utf-8", "\ufeff" + html);
        toast("Export สำเร็จ", `เดือน ${mk} • ${logs.length} รายการ`);
      };

      window.__exportAll = ()=> exportExcel("all").catch(e=>toast("Export ไม่สำเร็จ", e?.message||String(e)));
    }

    // ============================
    // Router
    // ============================
    async function render(){
      const { path, params } = parseHash();
      if(path === "/logs") return viewLogs();
      if(path === "/book"){
        const dir = params.get("dir") || "out";
        const time = params.get("time") || "";
        return viewBooking(dir === "back" ? "back" : "out", time);
      }
      return viewSchedule();
    }

    // ============================
    // Init
    // ============================
    async function init(){
      renderNav("/"); // show header immediately

      // Try init selected backend; if Firebase fails, fall back to local
      if(backend === FirebaseBackend){
        firebaseReady = await FirebaseBackend.init();
        if(!firebaseReady){
          // fall back
          firebaseReady = false;
        }
      }

      if(!FIREBASE_ENABLED || !firebaseReady){
        await LocalBackend.init();
      }

      if(!location.hash) location.hash = "#/";
      window.addEventListener("hashchange", ()=>{ render().catch(console.error); });
      await render();
    }

    // ============================
    // Basic tests (disabled by default)
    // ============================
    function assert(name, cond){ if(!cond) throw new Error("Test failed: " + name); }
    function runTests(){
      assert("addMin 11:00+20", addMin("11:00", 20) === "11:20");
      assert("addMin 11:30+20", addMin("11:30", 20) === "11:50");
      const d = todayKey();
      const st = buildDefaultState(d);
      assert("state has slots", Object.keys(st.slots).length === 16);
    }
    // runTests();

    init().catch(e=>{
      console.error(e);
      $("subtitle").textContent = "เกิดข้อผิดพลาดในการเริ่มระบบ";
      toast("Error", e?.message || String(e));
    });
  </script>
</body>
</html>
