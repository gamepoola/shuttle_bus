<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laya shuttle bus</title>
  <style>
    :root{
      --gold:#836A45;
      --gold-2:#B0A390;
      --gold-glow: rgba(131,106,69,.26);

      --bg1:#0c0906;
      --bg2:#15100a;

      --text:#f6efe6;
      --muted:#d2c3b2;
      --line: rgba(131,106,69,.22);

      --danger:#ff5a5f;
      --ok:#40c463;

      --shadow: 0 14px 36px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1100px 760px at 18% 0%, var(--gold-glow), transparent 60%),
        radial-gradient(900px 700px at 92% 18%, rgba(176,163,144,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .wrap{ max-width: 1120px; margin: 0 auto; padding: 18px; }

    header{
      position: sticky; top: 0;
      backdrop-filter: blur(10px);
      background: rgba(12,9,6,.62);
      border-bottom: 1px solid var(--line);
      z-index: 10;
    }

    .brand{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 14px 18px; }
    .brand-left{ display:flex; align-items:center; gap:14px; min-width:0; }
    .logo{ height: 44px; width:auto; display:block; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); }
    h1{ margin:0; font-size: 20px; letter-spacing: .6px; }
    .sub{ margin:2px 0 0 0; color: var(--muted); font-size: 13.5px; }

    .nav{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(18,13,8,.55);
      color: var(--text);
      font-size: 14px;
      font-weight: 650;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{ border-color: rgba(131,106,69,.55); background: rgba(131,106,69,.14); color: var(--gold-2); }

    .card{
      background: linear-gradient(180deg, rgba(18,13,8,.82), rgba(14,10,6,.74));
      border: 1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: 16px 16px 12px 16px;
      border-bottom: 1px solid rgba(131,106,69,.16);
      display:flex; align-items:flex-end; justify-content:space-between; gap: 12px;
    }
    .card-h h2{ margin:0; font-size: 17px; letter-spacing:.4px; }
    .card-h .hint{ margin:4px 0 0 0; color: var(--muted); font-size: 13.5px; line-height: 1.5; }
    .card-b{ padding: 14px 16px 16px 16px; }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 940px){ .grid{ grid-template-columns: 1.1fr .9fr; } }

    .slots{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 640px){ .slots{ grid-template-columns: 1fr 1fr; } }

    .slot{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(12,9,6,.35);
    }
    .slot .meta{ display:flex; flex-direction:column; gap: 6px; min-width: 0; }
    .slot .time{ font-size: 22px; font-weight: 900; letter-spacing:.3px; }
    .slot .seat{ font-size: 15.5px; color: var(--muted); }
    .slot .seat b{ font-size: 20px; color: var(--gold-2); }
    .slot .route{ font-size: 12.8px; color: rgba(210,195,178,.92); line-height: 1.45; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 560px; }

    .btn{
      appearance:none;
      border: 1px solid rgba(131,106,69,.35);
      background: rgba(131,106,69,.12);
      color: var(--gold-2);
      padding: 11px 14px;
      border-radius: 16px;
      font-weight: 850;
      letter-spacing: .2px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
      min-width: 110px;
      text-align:center;
      font-size: 15px;
    }
    .btn:hover{ border-color: rgba(131,106,69,.6); background: rgba(131,106,69,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity: .55; cursor:not-allowed; transform:none; }
    .btn.primary{
      background: linear-gradient(135deg, rgba(131,106,69,.22), rgba(131,106,69,.10));
      border-color: rgba(131,106,69,.55);
      color: var(--text);
    }
    .btn.ghost{
      background: rgba(18,13,8,.50);
      border-color: rgba(131,106,69,.22);
      color: var(--text);
    }
    .btn.danger{ background: rgba(255,90,95,.10); border-color: rgba(255,90,95,.45); color: #ffb0b3; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }
    .field{ display:flex; flex-direction:column; gap:6px; width: 100%; }
    label{ color: var(--muted); font-size: 13.5px; font-weight: 650; }
    input, select{
      width: 100%;
      padding: 13px 12px;
      border-radius: 16px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(12,9,6,.35);
      color: var(--text);
      outline:none;
      font-size: 16.5px;
      font-weight: 650;
    }
    select{ cursor:pointer; }
    input:focus, select:focus{ border-color: rgba(131,106,69,.55); box-shadow: 0 0 0 4px rgba(131,106,69,.14); }

    .kpi{
      display:flex; flex-direction:column; gap: 8px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(12,9,6,.35);
    }
    .kpi .big{ font-size: 30px; font-weight: 950; letter-spacing:.2px; color: var(--gold-2); }
    .kpi .small{ color: var(--muted); font-size: 13.5px; line-height: 1.55; }

    .mini{
      margin-top: 10px;
      border-top: 1px solid rgba(131,106,69,.16);
      padding-top: 10px;
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.65;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(12,9,6,.92);
      border: 1px solid rgba(131,106,69,.25);
      box-shadow: var(--shadow);
      padding: 12px 14px;
      border-radius: 18px;
      max-width: 92vw;
      width: 640px;
      display:none;
      z-index: 30;
    }
    .toast.show{ display:block; animation: pop .12s ease-out; }
    @keyframes pop{ from{ transform: translateX(-50%) translateY(6px); opacity:.0; } to{ transform: translateX(-50%) translateY(0); opacity:1; } }
    .toast .t{ font-weight: 900; color: var(--text); font-size: 15.5px; }
    .toast .d{ color: var(--muted); font-size: 13.5px; margin-top: 4px; line-height: 1.5; }

    table{ width: 100%; border-collapse: collapse; overflow:hidden; border-radius: 18px; border: 1px solid rgba(131,106,69,.18); background: rgba(12,9,6,.25); }
    th, td{ padding: 11px 11px; font-size: 13px; border-bottom: 1px solid rgba(131,106,69,.14); text-align:left; }
    th{ color: var(--muted); font-weight: 800; }
    tr:last-child td{ border-bottom:none; }

    .barwrap{ display:grid; gap: 8px; }
    .bar{ display:flex; align-items:center; gap: 10px; padding: 10px; border-radius: 16px; border: 1px solid rgba(131,106,69,.16); background: rgba(12,9,6,.25); }
    .bar .lbl{ width: 110px; color: var(--muted); font-size: 13.5px; font-weight: 700; }
    .bar .track{ flex: 1; height: 12px; border-radius: 999px; background: rgba(131,106,69,.12); overflow:hidden; }
    .bar .fill{ height: 100%; width: 0%; background: linear-gradient(90deg, rgba(131,106,69,.70), rgba(176,163,144,.35)); }
    .bar .num{ width: 62px; text-align:right; color: var(--gold-2); font-weight: 900; font-size: 13.5px; }

    .footer-actions{ display:flex; gap: 10px; flex-wrap:wrap; justify-content:flex-end; }

    .pill{ display:inline-flex; align-items:center; gap: 8px; padding: 8px 11px; border-radius: 999px; background: rgba(131,106,69,.10); border: 1px solid rgba(131,106,69,.20); color: var(--muted); font-size: 13.5px; font-weight: 650; }
    .dot{ width: 9px; height: 9px; border-radius: 50%; background: var(--gold); box-shadow: 0 0 0 4px rgba(131,106,69,.12); }

    .danger-text{ color: #ffb0b3; }
    .ok-text{ color: #a8f0b8; }

    .divider{ height:1px; background: rgba(131,106,69,.16); margin: 12px 0; }

    .note{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(12,9,6,.25);
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="brand-left">
        <img class="logo" alt="Laya Resort Phuket" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAT4AAACfCAMAAABX0UX9AAAAclBMVEX///+Gbkt7YDV/ZT19YjnX0MiDakWtnoqAZj+CaEKFbEjs6eV8YTfw7eqXg2i/s6Xn497Duaze2NGNdlejk3yun4zLwrfQyL50ViShkHnd19ByUx2ah2339vTj3tl5XTC3qpqQe12YhGm6rp5vUBZtTArXjnXzAAAQRUlEQVR4nO1d6baqOrMFAqEXFemUdnnu+7/ipUkCaiAVFPb4xmD+2WsrJmGSqlSXoCgHDhw4cODAgQMHDhw4cODAgQMHfg/zv0qb4KEWu3Qb/C18eX/8l76MKg1Wd3T9b2iiSv+vXrjM9fx17ReZpVI4TrmuEVkYGqoXBxWr46hUp/mmK69rwlKTxass7Kzt4IbpMPE+U09RQkf1BH09NUafZXzTV3d7Xr18TWCpKF7bASLDRF8NUwJ3XVVtkUAajL+1gjXgilRteeq1k6+dO+raDmqbzL61Dcji5LS92aKrEo/Qp5+/6axEnmhixZ2m0NdOnvsw/XC08veyOA/qSCgtNdF/wom6iMAT3pfqfKNh/eExW5eVv5dF1itbgLSEDtEq3/SGhf0Y+qAjVq6bxaBlkEhD/Ag+UWpiaXErMv2+kIs4FbLSDE8JZyu7GO7H2om+CA3DdU7CSwMivtp67afdRFeUGjE9NHdlF3vSV6QJEUqAtJArnXBtb1ElNMbyU2x/pfx3pe+pDSsdSFrORHytlauH+xAuUO7DIASo2jq7d1f6qpYJYilpYoOOrr4rBasRL6cmZqab/VzVyZ70xWn7iAO4tKhEfFeZFfFDyHqRxpPVbE0nu9LXr6IFXFpKcilaYVYVVS28ptUlCnNc19luhL49fDbj0QushLRERNJFTjIHJsBgrHqteh4ocFY5XsTu24O+cLAjqLRADGKHmGW5bF/lQ3xHl3R4Krmz3vbdj77rg1hwEtJypYpJ9tZUAOEWUb93fb2K3Y++nJrKg98LkxaTiK8uJ750Yi0hedDFn1iY+lWqjx670ec+7vTPk4S0EPrkvKoCEqMOmU+SDHETR1pF7EjfbXTfZaTFIKErqZhSBgjgMV2idKGFtQbmXvQVj8lck5EWGhC34H3dH4AAyt/E7b4QV8iE90GwF3319PYTCy4tBY38we/NFoYKWgU86pIWOtgWfcNe9KUv6yz13CDRFBp51u7ia3s8xaGCF12ijLZoDeyCYSf6LtXrf4m0AKYJDbGqDoZ15YtDBW+6ZHSFPFgXI3aiT3/zMeiMgkhLQUQLGDk9QVak+s1oN1d6bvvQl7zbYVLSElPVBAmpJ+JQgfKuS1qzikw/4Axn2Ic+9V3v+1LS8kfEF5JQ1CBz9E2XKKs9t13ou3/OCKk4R0Fk3aqFl0agwJP+0dCV2KKSse1d6Dt9+gzEcxOnfHtcEHCpPgNCBRxdorCkkQ5d3wfsQd+ZZ8b+SUlLA0x8hEv1RwwfukQZPTdQAwx70Jfx1sK7lLSwKNeyMxs/IEUdHF2isOCYJ5XZ24E+ny9QoZS0sLzlEj9FCspYnLjejpQtSrEDfRE/MkWlRZzy7RECEh83kN3B1SXK6LnJVCVtT1+fkOGBxAKA0kLLDhYSH9f/QDOZq0taPFd4btvTF8zZdpLSUgvF1wEFBWd0ycRzkwgcbE9fNavtPREfryB5Szy3NgaAEHOLaFbCiecmU9W1OX3x/E3VcgUSNG+p85WB/+6I8TGrS0bPDWaL9ticPlzPfiWR8u2xnLfMYTWigTb/XU5cIXix7tb0GUuW2E1SWpyFcjIDEmJuoS10diVJLHix7tb0hUsLA5UWaCCe5i09jquCYNHoBV2ijJ4bmI6N6Ssfi2YJiXOApYXmLT/5riEh5hbLitaQs0U3py9fdiFpnAMsLTRv+T6nAdVoPRZ1iTJ6btBi3W3pcx+CZBrxJcD907yl92YgA6rRhusERia8/HDAtvSZooAA9dzABRL8xAegGq2HQJcobKML1BbdlL63hAwPxHPTodJSkPt7yVsWFdB0zIVK7Slni25KXy1eUi+S0qIk1LOfqAUTWNvoPoROsaQtuil9FcAPoGyACyTyj8RHKZ7kA0zAEhVJ2aJb0veZkOGAem7gIgKa+BgjIyrQzihSAM3UFoXtx9mSPgQJXsp6bu06QdRfRZaBIAXq+SeIkkzGc9uQPl5ChgMa54CXtp9eEh9FWgN/B9ElrSqQsUU3pE+FrV5UWuCl7TTxYfWM59AACUiXKMxzA3GyHX13UNpGGeMc8AIJmvio3M6PgI4dpEuU0XOD2KLb0cdJ7vJxlSjWJZhs2ELQmtDkAdWuJC4LsUU3o28uIcNBI10gQRMf1rOGKViFn9zlg3pugAezGX03eKE69dwkCiTYdmkPGiu8Av26DtRzE/9iK/pmEzI8OPKl7XTDFjhW8ydR+B2AbdGt6Ktljle4SBTrvv7Ehq43ErpExhbdiL6FhAwPcGmhINYZgk5YCV2ijJ6bcK3eiD6SkCncc1mexQbMU9ZzU84DfdCTNqgu8bvxuMJJBd5muRF9Wqxcg1xLCewsWIx1yHtukvS1usSPTbUi0E5RsvhQM6Atug19sWfqVdo8k9IvCv9sBFnLZBPM3yv13GpoD5L0aXmYVhVqsuh5uVyCOsNpakXzj7QE2qLb0KdirYlfZ5IbZ2mKnzO3Sz03cGm7HH0XSw/j88uAivszfFS3uRsH2qKb0GdoIVelX2s7tWruEgiVFgo5+myN226R5GmaJTyNYcBs0U3oO81bLedAfWjmZ3dnsvhCS9spfaC1Ok7n7y9pheJ0+WwGtnFsC/rKZRvLvzTdiKfXlE+VnhoE9NxcGfqcevFr41aldmRMJqEfn4hbI7BFt6AvE0Z/iyTCjzS81a0ef5pN+mhqyWNbZOgzxJGqMjilD5TVQbuuRLn20OsaVI2+AX2+OCHTobheouzUNLkZ3LsHT3NusGJdGfoaWKTqnDzNvGn+bnXStUqzCIuZ4Q3oi9ad+0M9N1hpuwR95X+rDgFktujSr39PHyghwwPJucGKdSXoy1bsEu8QAWzR39MXSGxcfgFIWijg9AF1CacLgC36e/qqtSeBgqSFAk7fTGE/AABb9Of0xcCEDAcynhuYPsnYzxQl3Qk7f8nP6Vt5llYHGc8NTN9z/eOkntvCEVW/ps8AJ2Q4yOEFEmD6AGdZzYJ6bvNO1K/pC+VPoxhxhW+zhNK3XIwrgioq1v0xfSttLAqxtFBA6VtxuMgEsahY98f05WvPUB0glhYKIH2GRH6NB+K5zRbr/pY+VyYhw4MK3WYJpC9caTJT0Jzb3Kz4LX3mNyf0dxBKCwUsYHX99nGKbNGf0lfIJHf5IHEioecGoy//9nFSz22uWPen9D0ldoPNIAB6biD63O8fp7+cxPopfav9tRFQzw1En/mDNxlkiynfX9IHLaBbBCTOocDo+8JfG0E9N35l6kr6uKOGFtAtgh2Qs2zuQlJF9cLmSTioLcoLHJA6a2n6eHbtdwY+QwaafgD6ivmN2DIg9V/c6efrq+jjJrx1qTMoZnGnSYbFh3EdrlqqcYHuEhSB7KPjPc8SraHP5T2JSPuR8UiUzfJOGXKC4kL9u1t95wEx1POnDV6Gr5BUQNbXOVJhaCsOp+aCnC80t+l+AIkNLhg44dp3BbyDSi/HlSROkhR9d1R9WhVnT+Z00UWQfQfLOUIyReffBZXjX71ByKAvPvs4hIKWqEscun7OPE7Rb7dRVPJs5TnQXUPqku9hsjek8V/OV5xs+cP4ZsDexqbi8OVhXehIYTvyCtd4hh5m23kY/Ju3LEgyyNho2/k3I78RYpc4DseIuiC8xp7ggp4A0Hc2OQkhVitEoVft7WNsL6Ar1qs03bLe7YFL86i8DlXzg/kXp/oILw05FNTV0B/B4208ZZ5W/a+11e9fm6BIp315qUX1XJx8wBAjSd5tBb+g8L+KlQ5w/Re4nNrUt0v8t2pRn33/XaxvQPHWmf/Vm+MOHDhw4MCBAwcOHDhw4MCBAwcOHDhw4MCBA7vCvZk9osnuW3OCmn54jlTPQ/k0MWZkuqY1Y2FNTZp60t3bgfmKuRcZsDGwJMvNZB3VZkQuMsaPLrR9+lFs3voMTzntr2vuCRvDSpwrbHX5JR3pKh08tm2WCKOprKiyLaQjyxp3M+e6benItjDN15xsu29KR2SrRa71jWA8tDd3up4/jsEmrVeIZcBPljpcpLOfN6TYJkO0WvNekY8MDSM6+KprrPFAY1iJs46juEXw5zkVydCpTnMJCEhvtW6HcVkaNbLptvfGtpukvN88h9YBnHCYtE1dTIRRn1aOhyawcxram6n28T1s9mPINIccSaCNBQRtq8NF43lCJ/KKzxsm1ZG+hkmRroFwRMf+LKdj+OvH8FzxhuMFnHW6xaJE9Kjkz3R4Oz9omt0kf7REDpJjeHR/OLlRpUuEexMhQYKtF75HS+v80BnKQyTpc7BD9IWB+BVt6FcFHa9o6aNa5mKT8+w+SxJi673Is9DY4YFPm7xYfKRP8aaMwelrn+Hwpxx9DWaHO7X0cUvtt6fvrBO99klfYL8XV12ssUDCI7sMJvSd8KTiXYK+lvf+NqXou9kVK4D6d/S5VI45sw+9l9mdnLEC0MRDoeOEvnwtffagOGToC/RxUfmH9CWIHGnySV9RvdfieZNrYmsof5vQZ02bkKFPs2Vnn6FNmfl39IUO2WbLqaSKKxWFEwJ9fVLHX5K5OdLXivbkYgn6DGIYdZQMVTUi+lxNtSa1iwZCO9M3SOw9xB4Zn+o4tNqILfOJZzuWXvvsZ5NjCV192J9L6XMjHU9Ln+D0nTHRCZqKacWT4yzQpyrYsadFoQZSreF32stxH5vR11cgWhqy2Xtv2w+I4TnSpxSBZTm2lg1LXKlPlCGdil3RqNPed2tOv5Q0iunDUVfZdcmY7dnSR43fRfrCHFsxQlPdp1rE4t+Jvs5VwKpzY5Nexbl7HvCy3iah7uDBbG8nLWf29bPW6qzulz7E9KmDS4C8kAxCwzcyBLdZEl614zvHo11gICuhv3wdw0b02YF7djOMRqbmq0ivua5WncHS3sxE9+lM9/lnN9HfjxsV0+c0WZ5nZsCe4GQ5+Fukr1t03Wp8qfn+S0en+yZuBW/lHRHrw4GB2oTi5HXlzfHbhg2A7nsv0YWuvIPnE9n/2myubY/pucVC6Bvu9/I1zri3Mnq1+14eRQcZw4Xgk75iMt/pm2Ra+vp/C43Vsv8rwwWNJ5st0tf6b51TGdjjMC3yU7ryRpNH0Tf9C/oUfRyVRk7iYD5vYFEf+1/R165fVII4ZvPohgd2P/vaKUYfeGyRJpjdpztvq94v6MsxPeW2te2G9ZnRpzDj5Z+ZzSpzwz6XjkajUb7CJqEC0ybmgqvTSA2j79Vq/hF9CaILREhHOtIXk1DDv4u43D06vNZwKa8E/cF7ZYVRE/vdmYvYqcjTxY4e+UoRI6ciojp6Haoz3RP3G/o61sx2hbiGmPq4I33tl8OeHQPZMRv7hMjtnbYcV8P6pTrMZtXT/iO/6SLLnVFnV3Qe+o5ltx9ZmH0y0jc+ig66LU3fxBRhrfqWjdsOEWYbO282o4/2OJrNuq5N/W7BGFbi7KEx4oKHwFPrtDHQLfNGpukIebo52YRRt4auXmXMPD3Zk4jLZGPSl/SxVouoi+drKksX3OxxVxZ5+IY+jt2e6CDd3mT2ScC9lu+7UM7XL48BkUXb4Q825hw4cODAgQMHDhw4cODAgf9t/D/1dOoc8YFrtAAAAABJRU5ErkJggg==" />
        <div style="min-width:0">
          <h1>Laya shuttle bus</h1>
          <p class="sub">เลือก ขาไป/ขากลับ → เลือกรอบเวลา → เลือกจุดหมาย/จุดรับ → ระบบบอกเวลาถึง</p>
        </div>
      </div>
      <nav class="nav" id="nav"></nav>
    </div>
  </header>

  <main class="wrap" id="view"></main>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="t" id="toastTitle"></div>
    <div class="d" id="toastDesc"></div>
  </div>

  <script>
(function() {
  'use strict';

  // ============================
  // CONFIG
  // ============================
  var CAPACITY_PER_TRIP = 20;

  // Firebase config (provided by user)
  var FIREBASE_CONFIG = {"apiKey": "AIzaSyCql94D9FWgX4VIT5N1URKQDZ6IIyFGXys", "authDomain": "shuttle-bus-dd8e0.firebaseapp.com", "projectId": "shuttle-bus-dd8e0", "storageBucket": "shuttle-bus-dd8e0.firebasestorage.app", "messagingSenderId": "1097750801622", "appId": "1:1097750801622:web:7ed78fca83999be34ced77", "measurementId": "G-WTJP6RW7R8"};

  // LocalStorage keys (fallback)
  var LS_STATE = 'laya_bus_state_local_v1';
  var LS_LOGS  = 'laya_bus_logs_local_v1';
  var LS_UI    = 'laya_bus_ui_v1';

  // Firestore collection names (match your console screenshot)
  var COL_SLOTS = 'slots';
  var COL_LOGS  = 'logs';
  var COL_STATS = 'stats';

  // Firebase module version (CDN)
  var FB_VER = '10.12.5';

  // ============================
  // Schedule
  // ============================
  var DIRS = {
    out: {
      key: 'out',
      label: 'ขาไป',
      baseTimes: ['11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00'],
      timeline: [
        { key:'HOTEL', name:'Hotel', off: 0 },
        { key:'LAYAN', name:'Layan National Park', off: 5 },
        { key:'LEPHANG', name:'Le Phang Beach', off: 10 },
        { key:'BOAT', name:'Boat Avenue', off: 20 }
      ],
      selectLabel: 'จุดหมายปลายทาง',
      selectable: [
        { key:'LAYAN', name:'Layan National Park' },
        { key:'LEPHANG', name:'Le Phang Beach' },
        { key:'BOAT', name:'Boat Avenue' }
      ]
    },
    back: {
      key: 'back',
      label: 'ขากลับ',
      baseTimes: ['11:30','12:30','13:30','14:30','15:30','16:30','17:30','18:30'],
      timeline: [
        { key:'BOAT', name:'Boat Avenue', off: 0 },
        { key:'LEPHANG', name:'Le Phang Beach', off: 10 },
        { key:'LAYAN', name:'Layan National Park', off: 15 },
        { key:'HOTEL', name:'Hotel', off: 20 }
      ],
      selectLabel: 'จุดรับขึ้นรถ',
      selectable: [
        { key:'BOAT', name:'Boat Avenue' },
        { key:'LEPHANG', name:'Le Phang Beach' },
        { key:'LAYAN', name:'Layan National Park' }
      ]
    }
  };

  // ============================
  // Utils
  // ============================
  function pad2(n) { return String(n).padStart(2,'0'); }
  function timeToMin(t) {
    var p = String(t).split(':'); return (parseInt(p[0],10)*60) + parseInt(p[1],10);
  }
  function minToTime(min) {
    min = ((min % (24*60)) + (24*60)) % (24*60);
    var h = Math.floor(min/60); var m = min%60;
    return pad2(h)+':'+pad2(m);
  }
  function addMin(t, delta) { return minToTime(timeToMin(t) + delta); }

  function todayKey() {
    var d = new Date();
    return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate());
  }
  function monthKeyFromDateStr(dateStr) {
    if(!dateStr) return '';
    return String(dateStr).slice(0,7);
  }
  function currentMonthKey() {
    return monthKeyFromDateStr(todayKey());
  }
  function nowMin() {
    var d = new Date();
    return d.getHours()*60 + d.getMinutes();
  }
  function isClosedToday(baseTime) { return nowMin() >= timeToMin(baseTime); }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function toast(title, desc) {
    desc = desc || '';
    var el = document.getElementById('toast');
    document.getElementById('toastTitle').textContent = title;
    document.getElementById('toastDesc').textContent = desc;
    el.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(function(){ el.classList.remove('show'); }, 2600);
  }

  function parseHash() {
    var raw = location.hash || '#/';
    var parts = raw.replace(/^#/, '').split('?');
    var path = parts[0];
    var params = new URLSearchParams(parts[1] || '');
    return { path: path, params: params };
  }
  function setHash(path) { location.hash = '#'+path; }

  function downloadBlob(filename, mime, content) {
    var blob = new Blob([content], { type: mime });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function safeKey(s) {
    // Firestore field path safety (avoid '.', '#', '$', '/', '[', ']')
    return String(s || '').replace(/[.#$\/\[\]]/g, '_');
  }

  function timeKey(t) { return 't' + String(t).replace(':',''); }

  function slotDocId(dateStr, dirKey, baseTime) {
    return dateStr + '_' + dirKey + '_' + String(baseTime).replace(':','');
  }

  function calcTimes(dirKey, baseTime, placeKey) {
    var dir = DIRS[dirKey];
    if(!dir || !placeKey) return null;

    if(dirKey === 'out') {
      var dest = dir.timeline.find(function(x){ return x.key === placeKey; });
      if(!dest) return null;
      return {
        pickup: 'Hotel',
        destination: dest.name,
        pickupTime: baseTime,
        arriveTime: addMin(baseTime, dest.off)
      };
    }

    // back
    var pickupStop = dir.timeline.find(function(x){ return x.key === placeKey; });
    var hotelStop = dir.timeline.find(function(x){ return x.key === 'HOTEL'; });
    if(!pickupStop || !hotelStop) return null;

    return {
      pickup: pickupStop.name,
      destination: 'Hotel',
      pickupTime: addMin(baseTime, pickupStop.off),
      arriveTime: addMin(baseTime, hotelStop.off)
    };
  }

  // ============================
  // Local fallback store
  // ============================
  function buildDefaultLocalState() {
    var date = todayKey();
    var slots = {};
    Object.keys(DIRS).forEach(function(dirKey){
      DIRS[dirKey].baseTimes.forEach(function(t){
        var id = slotDocId(date, dirKey, t);
        slots[id] = { date: date, dir: dirKey, time: t, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {} };
      });
    });
    return { date: date, slots: slots };
  }

  function loadLocalState() {
    try {
      var base = buildDefaultLocalState();
      var raw = localStorage.getItem(LS_STATE);
      if(!raw) return base;
      var parsed = JSON.parse(raw);
      if(!parsed || parsed.date !== base.date) return base;
      var merged = { date: base.date, slots: Object.assign({}, base.slots, parsed.slots || {}) };
      return merged;
    } catch(e) {
      return buildDefaultLocalState();
    }
  }
  function saveLocalState(st) {
    localStorage.setItem(LS_STATE, JSON.stringify(st));
  }

  function loadLocalLogs() {
    try {
      var raw = localStorage.getItem(LS_LOGS);
      if(!raw) return [];
      var parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch(e) { return []; }
  }
  function addLocalLog(entry) {
    var logs = loadLocalLogs();
    logs.unshift(entry);
    localStorage.setItem(LS_LOGS, JSON.stringify(logs));
  }

  // ============================
  // Storage abstraction (Firebase preferred, local fallback)
  // ============================
  var storage = (function(){
    var mode = 'local';
    var fb = null; // { db, auth, fs }

    function getMode() { return mode; }

    async function initFirebase() {
      try {
        var modApp = await import('https://www.gstatic.com/firebasejs/' + FB_VER + '/firebase-app.js');
        var modAuth = await import('https://www.gstatic.com/firebasejs/' + FB_VER + '/firebase-auth.js');
        var modFs = await import('https://www.gstatic.com/firebasejs/' + FB_VER + '/firebase-firestore.js');

        var app = modApp.initializeApp(FIREBASE_CONFIG);
        var auth = modAuth.getAuth(app);

        await modAuth.signInAnonymously(auth);

        var db = modFs.getFirestore(app);

        fb = { db: db, auth: auth, fs: modFs };
        mode = 'firebase';
        return true;
      } catch(e) {
        mode = 'local';
        fb = null;
        console.warn('Firebase init failed, fallback to local:', e);
        toast('Firebase ใช้งานไม่ได้', 'สลับเป็นโหมด Local ชั่วคราว');
        return false;
      }
    }

    function isQuotaError(e) {
      var msg = (e && e.message) ? String(e.message) : '';
      var code = (e && e.code) ? String(e.code) : '';
      return code === 'resource-exhausted' || msg.includes('Quota') || msg.includes('resource-exhausted') || msg.includes('429');
    }

    async function getSlot(dateStr, dirKey, timeStr) {
      var id = slotDocId(dateStr, dirKey, timeStr);

      if(mode !== 'firebase') {
        var st = loadLocalState();
        var slot = st.slots[id];
        if(!slot) {
          slot = { date: dateStr, dir: dirKey, time: timeStr, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {} };
          st.slots[id] = slot;
          saveLocalState(st);
        }
        return JSON.parse(JSON.stringify(slot));
      }

      try {
        var fs = fb.fs;
        var ref = fs.doc(fb.db, COL_SLOTS, id);
        var snap = await fs.getDoc(ref);
        if(!snap.exists()) {
          var def = { date: dateStr, dir: dirKey, time: timeStr, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {}, updatedAt: fs.serverTimestamp() };
          await fs.setDoc(ref, def, { merge: true });
          def.updatedAt = null;
          return def;
        }
        return Object.assign({}, snap.data());
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) {
          mode = 'local';
          toast('Quota Firebase เต็ม', 'สลับเป็น Local ชั่วคราว');
          return getSlot(dateStr, dirKey, timeStr);
        }
        throw e;
      }
    }

    async function listSlots(dateStr, dirKey) {
      var times = DIRS[dirKey].baseTimes.slice();
      var out = [];
      for(var i=0;i<times.length;i++) {
        var t = times[i];
        var s = await getSlot(dateStr, dirKey, t);
        out.push({ time: t, capacity: s.capacity || CAPACITY_PER_TRIP, available: (typeof s.available==='number'? s.available : CAPACITY_PER_TRIP) });
      }
      return out;
    }

    async function book(dateStr, dirKey, timeStr, roomRaw, pax, placeKey, timesInfo) {
      var room = String(roomRaw || '').trim();
      if(!room) return { ok:false, msg:'กรุณาใส่เลขห้อง' };
      var roomK = safeKey(room);

      if(mode !== 'firebase') {
        var st = loadLocalState();
        var id = slotDocId(dateStr, dirKey, timeStr);
        var slot = st.slots[id] || { date: dateStr, dir: dirKey, time: timeStr, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {} };
        if(slot.bookings[roomK] && slot.bookings[roomK].pax > 0) return { ok:false, msg:'ห้องนี้จองแล้ว (กันการกดซ้ำ)' };
        if(pax > slot.available) return { ok:false, msg:'ที่นั่งไม่พอ' };
        slot.bookings[roomK] = {
          room: room, pax: pax, placeKey: placeKey,
          pickup: timesInfo.pickup, destination: timesInfo.destination,
          pickupTime: timesInfo.pickupTime, arriveTime: timesInfo.arriveTime,
          tsMs: Date.now()
        };
        slot.available -= pax;
        st.slots[id] = slot;
        saveLocalState(st);
        addLocalLog({ action:'BOOK', pax:pax, room:room, time:timeStr, dir:dirKey, date:dateStr, tsMs: Date.now() });
        return { ok:true };
      }

      try {
        var fs = fb.fs;
        var db = fb.db;
        var slotId = slotDocId(dateStr, dirKey, timeStr);
        var slotRef = fs.doc(db, COL_SLOTS, slotId);

        var monthKey = monthKeyFromDateStr(dateStr);
        var statsRef = fs.doc(db, COL_STATS, monthKey);
        var logRef = fs.doc(fs.collection(db, COL_LOGS)); // auto-id

        await fs.runTransaction(db, async function(tx){
          var snap = await tx.get(slotRef);
          var data;
          if(!snap.exists()) {
            data = { date: dateStr, dir: dirKey, time: timeStr, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {} };
            tx.set(slotRef, Object.assign({}, data, { updatedAt: fs.serverTimestamp() }), { merge: true });
          } else {
            data = snap.data();
          }

          var capacity = (typeof data.capacity==='number') ? data.capacity : CAPACITY_PER_TRIP;
          var available = (typeof data.available==='number') ? data.available : capacity;
          var bookings = data.bookings || {};

          var existing = bookings[roomK];
          if(existing && existing.pax > 0) throw new Error('ห้องนี้จองแล้ว (กันการกดซ้ำ)');
          if(pax > available) throw new Error('ที่นั่งไม่พอ');

          var bookingObj = {
            room: room, pax: pax, placeKey: placeKey,
            pickup: timesInfo.pickup, destination: timesInfo.destination,
            pickupTime: timesInfo.pickupTime, arriveTime: timesInfo.arriveTime,
            tsMs: Date.now()
          };

          var upd = {};
          upd.available = available - pax;
          upd.updatedAt = fs.serverTimestamp();
          upd['bookings.' + roomK] = bookingObj;
          tx.set(slotRef, upd, { merge: true });

          var statField = dirKey + '.' + timeKey(timeStr);
          var statUpd = {}; statUpd[statField] = fs.increment(pax); statUpd.updatedAt = fs.serverTimestamp();
          tx.set(statsRef, statUpd, { merge: true });

          tx.set(logRef, {
            action: 'BOOK', pax: pax, room: room, time: timeStr, dir: dirKey,
            date: dateStr, month: monthKey,
            placeKey: placeKey,
            pickup: timesInfo.pickup, destination: timesInfo.destination,
            pickupTime: timesInfo.pickupTime, arriveTime: timesInfo.arriveTime,
            tsMs: Date.now(),
            ts: fs.serverTimestamp()
          });
        });

        return { ok:true };
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) {
          mode = 'local';
          toast('Quota Firebase เต็ม', 'สลับเป็น Local ชั่วคราว');
          return book(dateStr, dirKey, timeStr, roomRaw, pax, placeKey, timesInfo);
        }
        return { ok:false, msg: (e && e.message) ? e.message : 'จองไม่สำเร็จ' };
      }
    }

    async function cancel(dateStr, dirKey, timeStr, roomRaw, pax) {
      var room = String(roomRaw || '').trim();
      if(!room) return { ok:false, msg:'กรุณาใส่เลขห้อง' };
      var roomK = safeKey(room);

      if(mode !== 'firebase') {
        var st = loadLocalState();
        var id = slotDocId(dateStr, dirKey, timeStr);
        var slot = st.slots[id];
        if(!slot) return { ok:false, msg:'ไม่พบรอบเวลานี้' };
        var existing = slot.bookings[roomK];
        var booked = existing ? (existing.pax || 0) : 0;
        if(booked <= 0) return { ok:false, msg:'ห้องนี้ยังไม่มีการจองในรอบนี้' };
        if(pax > booked) return { ok:false, msg:'ยกเลิกเกินจำนวนที่จองไว้' };
        var left = booked - pax;
        if(left === 0) delete slot.bookings[roomK];
        else slot.bookings[roomK].pax = left;
        slot.available = Math.min(slot.capacity || CAPACITY_PER_TRIP, (slot.available || 0) + pax);
        saveLocalState(st);
        addLocalLog({ action:'CANCEL', pax:pax, room:room, time:timeStr, dir:dirKey, date:dateStr, tsMs: Date.now() });
        return { ok:true };
      }

      try {
        var fs = fb.fs;
        var db = fb.db;
        var slotId = slotDocId(dateStr, dirKey, timeStr);
        var slotRef = fs.doc(db, COL_SLOTS, slotId);
        var monthKey = monthKeyFromDateStr(dateStr);
        var logRef = fs.doc(fs.collection(db, COL_LOGS));

        await fs.runTransaction(db, async function(tx){
          var snap = await tx.get(slotRef);
          if(!snap.exists()) throw new Error('ไม่พบรอบเวลานี้');
          var data = snap.data();
          var capacity = (typeof data.capacity==='number') ? data.capacity : CAPACITY_PER_TRIP;
          var available = (typeof data.available==='number') ? data.available : capacity;
          var bookings = data.bookings || {};
          var existing = bookings[roomK];
          var booked = existing ? (existing.pax || 0) : 0;
          if(booked <= 0) throw new Error('ห้องนี้ยังไม่มีการจองในรอบนี้');
          if(pax > booked) throw new Error('ยกเลิกเกินจำนวนที่จองไว้');

          var left = booked - pax;
          var upd = {};
          upd.available = Math.min(capacity, available + pax);
          upd.updatedAt = fs.serverTimestamp();
          if(left === 0) upd['bookings.'+roomK] = fs.deleteField();
          else upd['bookings.'+roomK+'.pax'] = left;
          tx.set(slotRef, upd, { merge:true });

          tx.set(logRef, {
            action: 'CANCEL',
            pax: pax,
            room: room,
            time: timeStr,
            dir: dirKey,
            date: dateStr,
            month: monthKey,
            tsMs: Date.now(),
            ts: fs.serverTimestamp()
          });
        });

        return { ok:true };
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) {
          mode = 'local';
          toast('Quota Firebase เต็ม', 'สลับเป็น Local ชั่วคราว');
          return cancel(dateStr, dirKey, timeStr, roomRaw, pax);
        }
        return { ok:false, msg: (e && e.message) ? e.message : 'ยกเลิกไม่สำเร็จ' };
      }
    }

    async function getStatsMonth(monthKey) {
      if(mode !== 'firebase') {
        var logs = loadLocalLogs();
        var out = { out: {}, back: {} };
        Object.keys(DIRS).forEach(function(dk){
          DIRS[dk].baseTimes.forEach(function(t){ out[dk][timeKey(t)] = 0; });
        });
        logs.forEach(function(e){
          if(!e || e.action !== 'BOOK') return;
          if(monthKeyFromDateStr(e.date) !== monthKey) return;
          if(out[e.dir] && out[e.dir][timeKey(e.time)] !== undefined) out[e.dir][timeKey(e.time)] += (e.pax||0);
        });
        return out;
      }

      try {
        var fs = fb.fs;
        var ref = fs.doc(fb.db, COL_STATS, monthKey);
        var snap = await fs.getDoc(ref);
        if(!snap.exists()) return { out:{}, back:{} };
        var data = snap.data() || {};
        return { out: data.out || {}, back: data.back || {} };
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) { mode='local'; toast('Quota Firebase เต็ม','สลับเป็น Local ชั่วคราว'); return getStatsMonth(monthKey); }
        return { out:{}, back:{} };
      }
    }

    function rangeMsForDay(dateStr) {
      var parts = String(dateStr).split('-');
      var y = parseInt(parts[0],10); var m = parseInt(parts[1],10)-1; var d = parseInt(parts[2],10);
      var start = new Date(y,m,d,0,0,0,0).getTime();
      var end = new Date(y,m,d+1,0,0,0,0).getTime();
      return { start:start, end:end };
    }
    function rangeMsForMonth(monthStr) {
      var parts = String(monthStr).split('-');
      var y = parseInt(parts[0],10); var m = parseInt(parts[1],10)-1;
      var start = new Date(y,m,1,0,0,0,0).getTime();
      var end = new Date(y,m+1,1,0,0,0,0).getTime();
      return { start:start, end:end };
    }

    async function queryLogs(opts) {
      opts = opts || {};
      var modeQ = opts.mode || 'all';
      var limitN = opts.limit || 250;
      if(limitN < 1) limitN = 250;

      if(mode !== 'firebase') {
        var logs = loadLocalLogs();
        if(modeQ === 'day') logs = logs.filter(function(e){ return e && e.date === opts.value; });
        if(modeQ === 'month') logs = logs.filter(function(e){ return monthKeyFromDateStr(e.date) === opts.value; });
        return logs.slice(0, limitN);
      }

      try {
        var fs = fb.fs;
        var db = fb.db;
        var col = fs.collection(db, COL_LOGS);
        var q;
        if(modeQ === 'day') {
          var r = rangeMsForDay(opts.value);
          q = fs.query(col, fs.where('tsMs','>=',r.start), fs.where('tsMs','<',r.end), fs.orderBy('tsMs','desc'), fs.limit(limitN));
        } else if(modeQ === 'month') {
          var rm = rangeMsForMonth(opts.value);
          q = fs.query(col, fs.where('tsMs','>=',rm.start), fs.where('tsMs','<',rm.end), fs.orderBy('tsMs','desc'), fs.limit(limitN));
        } else {
          q = fs.query(col, fs.orderBy('tsMs','desc'), fs.limit(limitN));
        }
        var snaps = await fs.getDocs(q);
        var out = [];
        snaps.forEach(function(docSnap){ out.push(docSnap.data()); });
        return out;
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) { mode='local'; toast('Quota Firebase เต็ม','สลับเป็น Local ชั่วคราว'); return queryLogs(opts); }
        return [];
      }
    }

    async function resetDay(dateStr) {
      if(mode !== 'firebase') {
        var st = buildDefaultLocalState();
        saveLocalState(st);
        return true;
      }
      try {
        var fs = fb.fs;
        var db = fb.db;
        var promises = [];
        Object.keys(DIRS).forEach(function(dirKey){
          DIRS[dirKey].baseTimes.forEach(function(t){
            var id = slotDocId(dateStr, dirKey, t);
            var ref = fs.doc(db, COL_SLOTS, id);
            promises.push(fs.setDoc(ref, { date: dateStr, dir: dirKey, time: t, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {}, updatedAt: fs.serverTimestamp() }, { merge:true }));
          });
        });
        await Promise.all(promises);
        return true;
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) { mode='local'; toast('Quota Firebase เต็ม','สลับเป็น Local ชั่วคราว'); return resetDay(dateStr); }
        return false;
      }
    }

    return {
      initFirebase: initFirebase,
      getMode: getMode,
      getSlot: getSlot,
      listSlots: listSlots,
      book: book,
      cancel: cancel,
      getStatsMonth: getStatsMonth,
      queryLogs: queryLogs,
      resetDay: resetDay
    };
  })();

  // ============================
  // UI helpers
  // ============================
  function $(id) { return document.getElementById(id); }

  function renderNav(activeKey) {
    var nav = $('nav');
    nav.innerHTML = '';
    var items = [
      { key:'/', label:'ตารางเวลา', href:'#/' },
      { key:'/logs', label:'บันทึก/สถิติ', href:'#/logs' }
    ];
    items.forEach(function(it){
      var a = document.createElement('a');
      a.href = it.href;
      a.className = 'chip' + (activeKey===it.key ? ' active' : '');
      a.textContent = it.label;
      nav.appendChild(a);
    });
  }

  function loadUi() {
    try {
      var raw = localStorage.getItem(LS_UI);
      if(!raw) return { dir:'out' };
      var p = JSON.parse(raw);
      return { dir: (p && p.dir === 'back') ? 'back' : 'out' };
    } catch(e) { return { dir:'out' }; }
  }
  function saveUi(ui) { localStorage.setItem(LS_UI, JSON.stringify(ui)); }

  // ============================
  // Excel export
  // ============================
  function buildExcelHtml(logs) {
    var rows = logs.map(function(e){
      var ts = e.tsMs ? new Date(e.tsMs).toLocaleString() : '';
      var action = e.action || '';
      var dir = e.dir === 'out' ? 'ขาไป' : (e.dir === 'back' ? 'ขากลับ' : (e.dir || ''));
      var time = e.time || '';
      var room = e.room || '';
      var pax = (typeof e.pax === 'number') ? e.pax : (e.pax || '');
      var pickup = e.pickup || '';
      var destination = e.destination || '';
      var pickupTime = e.pickupTime || '';
      var arriveTime = e.arriveTime || '';
      var date = e.date || '';
      return '\n<tr>' +
        '<td>' + escapeHtml(ts) + '</td>' +
        '<td>' + escapeHtml(date) + '</td>' +
        '<td>' + escapeHtml(action) + '</td>' +
        '<td>' + escapeHtml(dir) + '</td>' +
        '<td>' + escapeHtml(time) + '</td>' +
        '<td>' + escapeHtml(room) + '</td>' +
        '<td>' + escapeHtml(pax) + '</td>' +
        '<td>' + escapeHtml(pickup) + '</td>' +
        '<td>' + escapeHtml(destination) + '</td>' +
        '<td>' + escapeHtml(pickupTime) + '</td>' +
        '<td>' + escapeHtml(arriveTime) + '</td>' +
      '</tr>';
    }).join('\n');

    return (
      '<!doctype html>\n<html>\n<head>\n<meta charset="UTF-8" />\n</head>\n<body>' +
      '<table border="1">' +
      '<thead><tr>' +
      '<th>Timestamp</th><th>Date</th><th>Action</th><th>Direction</th><th>Time</th><th>Room</th><th>Pax</th>' +
      '<th>Pickup</th><th>Destination</th><th>Pickup time</th><th>Arrival time</th>' +
      '</tr></thead>' +
      '<tbody>' + rows + '</tbody>' +
      '</table>' +
      '</body></html>'
    );
  }

  async function doExport(mode, value) {
    var logs;
    if(mode === 'day') logs = await storage.queryLogs({ mode:'day', value:value, limit: 1000000 });
    else if(mode === 'month') logs = await storage.queryLogs({ mode:'month', value:value, limit: 1000000 });
    else logs = await storage.queryLogs({ mode:'all', limit: 1000000 });

    var html = buildExcelHtml(logs);
    var suffix = (mode === 'day') ? value : (mode === 'month' ? value : ('all-' + todayKey()));
    downloadBlob('laya-shuttle-logs-' + suffix + '.xls', 'application/vnd.ms-excel;charset=utf-8', '\ufeff' + html);
  }

  // ============================
  // Views
  // ============================
  async function viewSchedule() {
    renderNav('/');
    var ui = loadUi();
    var date = todayKey();
    var dirKey = ui.dir;

    var mode = storage.getMode();

    var slots = await storage.listSlots(date, dirKey);

    var cardsHtml = slots.map(function(s){
      var closed = isClosedToday(s.time);
      var btnLabel = closed ? 'ปิดแล้ว' : 'เลือก';
      var btnKind = closed ? 'primary' : 'pick';
      var availClass = (s.available===0) ? 'danger' : '';
      return '\n<div class="slot">' +
        '<div class="meta">' +
          '<div class="time">' + escapeHtml(s.time) + '</div>' +
          '<div class="seat">ที่นั่งว่าง: <b class="' + availClass + '">' + s.available + '</b> / ' + s.capacity + (closed ? ' • <span class="danger-text">ปิดทำรายการ</span>' : '') + '</div>' +
        '</div>' +
        '<button class="btn ' + btnKind + '" ' + ((closed || s.available===0) ? 'disabled' : '') + ' onclick="window.__openBooking(\''+dirKey+'\',\''+s.time+'\')">' + btnLabel + '</button>' +
      '</div>';
    }).join('\n');

    var right = '';
    right += '<section class="card">';
    right += '<div class="card-h"><div><h2>Export Log</h2><p class="hint">Storage: <b>' + (mode==='firebase' ? 'Firebase' : 'Local') + '</b> • Export แยกวัน/เดือน/ทั้งหมดได้</p></div></div>';
    right += '<div class="card-b">';
    right += '<div class="footer-actions">' +
      '<button class="btn ghost" onclick="window.__exportDay()">Export วันนี้</button>' +
      '<button class="btn ghost" onclick="window.__exportMonth()">Export เดือนนี้</button>' +
      '<button class="btn ghost" onclick="window.__exportAll()">Export ทั้งหมด</button>' +
      '<button class="btn danger" onclick="window.__resetSeats()">รีเซ็ตที่นั่ง (วันนี้)</button>' +
    '</div>';
    right += '<div class="mini">Tip: ถ้า Firebase โควต้าเต็ม ระบบจะสลับเป็น Local ชั่วคราว เพื่อให้ใช้งานต่อได้</div>';
    right += '</div></section>';

    $('view').innerHTML =
      '<div class="grid">' +
        '<section class="card">' +
          '<div class="card-h">' +
            '<div><h2>ตารางเวลาเดินรถ</h2><p class="hint">เลือก <b>ขาไป/ขากลับ</b> แล้วกด “เลือก” เพื่อไปหน้าเลือกปลายทาง/จุดรับ</p></div>' +
            '<div class="row">' +
              '<span class="pill"><span class="dot"></span> ' + (mode==='firebase' ? 'Firebase' : 'Local') + '</span>' +
              '<button class="chip ' + (dirKey==='out'?'active':'') + '" onclick="window.__setDir(\'out\')">ขาไป</button>' +
              '<button class="chip ' + (dirKey==='back'?'active':'') + '" onclick="window.__setDir(\'back\')">ขากลับ</button>' +
            '</div>' +
          '</div>' +
          '<div class="card-b"><div class="slots">' + cardsHtml + '</div></div>' +
        '</section>' +
        right +
      '</div>';

    window.__setDir = function(d){
      var ui2 = loadUi();
      ui2.dir = (d==='back') ? 'back' : 'out';
      saveUi(ui2);
      render().catch(console.error);
    };

    window.__openBooking = function(d, t){
      setHash('/book?dir=' + encodeURIComponent(d) + '&time=' + encodeURIComponent(t));
    };

    window.__exportDay = function(){ doExport('day', todayKey()).catch(console.error); };
    window.__exportMonth = function(){ doExport('month', currentMonthKey()).catch(console.error); };
    window.__exportAll = function(){ doExport('all','').catch(console.error); };

    window.__resetSeats = function(){
      if(!confirm('ต้องการรีเซ็ตที่นั่งของวันนี้ (ไม่ลบ Log) ใช่ไหม?')) return;
      storage.resetDay(todayKey()).then(function(ok){
        if(ok) toast('รีเซ็ตที่นั่งแล้ว', 'วันที่ ' + todayKey());
        else toast('รีเซ็ตไม่สำเร็จ', 'ตรวจสอบ Firebase/Quota');
        render().catch(console.error);
      });
    };
  }

  async function viewBooking(dirKey, baseTime) {
    renderNav('/');
    var date = todayKey();
    var dir = (dirKey==='back') ? DIRS.back : DIRS.out;
    var closed = isClosedToday(baseTime);

    var slot = await storage.getSlot(date, dir.key, baseTime);

    var options = dir.selectable.map(function(p){
      return '<option value="' + escapeHtml(p.key) + '">' + escapeHtml(p.name) + '</option>';
    }).join('');

    $('view').innerHTML =
      '<section class="card">' +
        '<div class="card-h">' +
          '<div><h2>' + escapeHtml(dir.label) + ' • รอบเวลา <span style="color:var(--gold-2)">' + escapeHtml(baseTime) + '</span></h2>' +
          '<p class="hint">เลือก ' + escapeHtml(dir.selectLabel) + ' ก่อน แล้วระบบจะแสดงเวลาถึง</p></div>' +
          '<div class="row"><button class="btn ghost" onclick="window.__back()">ย้อนกลับ</button></div>' +
        '</div>' +
        '<div class="card-b" style="max-width: 860px;">' +
          '<div class="row" style="gap:12px">' +
            '<div class="field" style="flex:1 1 360px">' +
              '<label for="place">' + escapeHtml(dir.selectLabel) + '</label>' +
              '<select id="place"><option value="">— โปรดเลือก —</option>' + options + '</select>' +
            '</div>' +
            '<div class="field" style="flex:1 1 260px">' +
              '<label>เวลาถึงโดยประมาณ</label>' +
              '<input id="arrival" readonly value="—" />' +
            '</div>' +
          '</div>' +
          '<div class="note" id="routeNote">เลือก ' + escapeHtml(dir.selectLabel) + ' เพื่อคำนวณเวลา</div>' +
          '<div class="divider"></div>' +
          '<div class="row" style="gap:12px">' +
            '<div class="field" style="flex:1 1 260px">' +
              '<label for="room">เลขห้อง</label>' +
              '<input id="room" autocomplete="off" placeholder="เช่น A105" />' +
            '</div>' +
            '<div class="field" style="flex:0 0 240px">' +
              '<label for="pax">จำนวนคน</label>' +
              '<input id="pax" type="number" min="1" step="1" inputmode="numeric" placeholder="เช่น 2" />' +
            '</div>' +
          '</div>' +
          '<div style="height:12px"></div>' +
          '<div class="row">' +
            '<button id="btnBook" class="btn primary" onclick="window.__book()">จอง</button>' +
            '<button class="btn danger" onclick="window.__cancel()">ยกเลิกการจอง</button>' +
            '<span class="pill"><span class="dot"></span> 1 ห้อง/1 รอบ จองได้ครั้งเดียว</span>' +
          '</div>' +
          '<div class="mini" id="mini"></div>' +
          '<div class="note" id="note"></div>' +
          '<div class="divider"></div>' +
          '<div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14);">' +
            '<div class="card-h" style="border-bottom-color: rgba(131,106,69,.10)"><div><h2 style="font-size:15.5px">รายการจองในรอบนี้</h2><p class="hint">แสดงเลขห้อง/จำนวนคน/เส้นทาง/เวลาถึง</p></div></div>' +
            '<div class="card-b" id="bookingsTable"></div>' +
          '</div>' +
        '</div>' +
      '</section>';

    var placeEl = $('place');
    var arrivalEl = $('arrival');
    var routeNoteEl = $('routeNote');
    var roomEl = $('room');
    var paxEl = $('pax');
    var bookBtn = $('btnBook');
    var noteEl = $('note');

    function updateArrival() {
      var t = calcTimes(dir.key, baseTime, placeEl.value);
      if(!t) {
        arrivalEl.value = '—';
        routeNoteEl.textContent = 'เลือก ' + dir.selectLabel + ' เพื่อคำนวณเวลา';
        return;
      }
      if(dir.key === 'out') {
        arrivalEl.value = 'ถึง ' + t.destination + ' ' + t.arriveTime;
        routeNoteEl.innerHTML = 'ออกจาก <b>' + escapeHtml(t.pickup) + '</b> เวลา <b>' + escapeHtml(t.pickupTime) + '</b> • ถึง <b>' + escapeHtml(t.destination) + '</b> เวลา <b>' + escapeHtml(t.arriveTime) + '</b>';
      } else {
        arrivalEl.value = 'ถึง Hotel ' + t.arriveTime;
        routeNoteEl.innerHTML = 'รับที่ <b>' + escapeHtml(t.pickup) + '</b> เวลา <b>' + escapeHtml(t.pickupTime) + '</b> • ถึง <b>Hotel</b> เวลา <b>' + escapeHtml(t.arriveTime) + '</b>';
      }
    }

    function renderBookings(slotData) {
      var sl = slotData;
      var b = sl.bookings || {};
      var entries = Object.keys(b).map(function(k){ return b[k]; }).filter(Boolean);
      entries.sort(function(a,c){ return String(a.room||'').localeCompare(String(c.room||'')); });
      var wrap = $('bookingsTable');
      if(entries.length === 0) { wrap.innerHTML = '<div class="mini">ยังไม่มีการจองในรอบนี้</div>'; return; }
      var rows = entries.map(function(obj){
        var line = (obj.pickup && obj.destination) ? (obj.pickup + ' → ' + obj.destination) : '';
        var arrive = obj.arriveTime ? ('ถึง ' + obj.arriveTime) : '';
        return '<tr><td>' + escapeHtml(obj.room||'') + '</td><td><b>' + escapeHtml(obj.pax||'') + '</b></td><td>' + escapeHtml(line) + '</td><td>' + escapeHtml(arrive) + '</td></tr>';
      }).join('');
      wrap.innerHTML = '<table><thead><tr><th>เลขห้อง</th><th>จำนวนคน</th><th>เส้นทาง</th><th>เวลาถึง</th></tr></thead><tbody>' + rows + '</tbody></table>';
    }

    function updateMini(slotData) {
      var sl = slotData;
      var closedNow = isClosedToday(baseTime);
      $('mini').innerHTML = '<b>คงเหลือ:</b> ที่นั่งว่าง <b class="' + (sl.available===0?'danger':'') + '">' + sl.available + '</b> / ' + sl.capacity + (closedNow ? ' • <span class="danger-text"><b>ปิดทำรายการแล้ว</b></span>' : '') + '<br/><span style="color:var(--muted)">Tip: หากต้องการเปลี่ยนจำนวนหรือเปลี่ยนจุด ให้ยกเลิกจนเหลือ 0 แล้วจองใหม่</span>';
      if(closedNow) {
        bookBtn.disabled = true;
        placeEl.disabled = true;
        roomEl.disabled = true;
        paxEl.disabled = true;
      }
    }

    function updateBookBtn(slotData) {
      var room = String(roomEl.value||'').trim();
      if(!room) { if(!isClosedToday(baseTime)) bookBtn.disabled = false; noteEl.textContent=''; return; }
      var roomK = safeKey(room);
      var ex = slotData.bookings && slotData.bookings[roomK];
      var booked = ex ? (ex.pax||0) : 0;
      if(booked > 0) {
        bookBtn.disabled = true;
        var placeText = (ex.pickup && ex.destination) ? (ex.pickup + ' → ' + ex.destination) : '';
        noteEl.innerHTML = 'ห้อง <b>' + escapeHtml(room) + '</b> จองแล้ว <b>' + booked + '</b> คนในรอบนี้' + (placeText ? (' (' + escapeHtml(placeText) + ')') : '') + ' — กันการกดซ้ำ';
      } else {
        if(!isClosedToday(baseTime)) bookBtn.disabled = false;
        noteEl.textContent = '';
      }
    }

    async function refresh() {
      var sl = await storage.getSlot(date, dir.key, baseTime);
      updateArrival();
      updateMini(sl);
      updateBookBtn(sl);
      renderBookings(sl);
      return sl;
    }

    placeEl.addEventListener('change', function(){ updateArrival(); });
    roomEl.addEventListener('input', function(){ refresh().catch(console.error); });

    window.__back = function(){ setHash('/'); };

    window.__book = async function(){
      if(closed) { toast('ปิดทำรายการแล้ว','รอบนี้ไม่สามารถจองได้'); return; }
      var placeKey = String(placeEl.value||'').trim();
      var room = String(roomEl.value||'').trim();
      var pax = parseInt(paxEl.value,10);
      if(!placeKey) { toast('ข้อมูลไม่ครบ','กรุณาเลือก ' + dir.selectLabel); return; }
      if(!room) { toast('ข้อมูลไม่ครบ','กรุณาใส่เลขห้อง'); return; }
      if(!Number.isFinite(pax) || pax<=0) { toast('ข้อมูลไม่ครบ','กรุณาใส่จำนวนคน'); return; }
      var t = calcTimes(dir.key, baseTime, placeKey);
      if(!t) { toast('ข้อมูลไม่ถูกต้อง','ไม่สามารถคำนวณเวลาได้'); return; }

      bookBtn.disabled = true;
      var res = await storage.book(date, dir.key, baseTime, room, pax, placeKey, t);
      if(!res.ok) { toast('จองไม่สำเร็จ', res.msg||''); await refresh(); return; }
      toast('จองสำเร็จ', dir.label + ' • ห้อง ' + room + ' • ' + pax + ' คน • ถึง ' + t.arriveTime);
      await refresh();
    };

    window.__cancel = async function(){
      if(closed) { toast('ปิดทำรายการแล้ว','รอบนี้ไม่สามารถยกเลิกได้'); return; }
      var room = String(roomEl.value||'').trim();
      var pax = parseInt(paxEl.value,10);
      if(!room) { toast('ข้อมูลไม่ครบ','กรุณาใส่เลขห้อง'); return; }
      if(!Number.isFinite(pax) || pax<=0) { toast('ข้อมูลไม่ครบ','กรุณาใส่จำนวนคน'); return; }
      var res = await storage.cancel(date, dir.key, baseTime, room, pax);
      if(!res.ok) { toast('ยกเลิกไม่สำเร็จ', res.msg||''); await refresh(); return; }
      toast('ยกเลิกสำเร็จ', 'คืนที่นั่ง ' + pax + ' คน • ห้อง ' + room);
      await refresh();
    };

    await refresh();
  }

  async function viewLogs() {
    renderNav('/logs');
    var monthKey = currentMonthKey();
    var stats = await storage.getStatsMonth(monthKey);

    function val(dirKey, t) {
      var k = timeKey(t);
      return (stats[dirKey] && typeof stats[dirKey][k] === 'number') ? stats[dirKey][k] : 0;
    }

    var outTop = { time:null, value:0 };
    DIRS.out.baseTimes.forEach(function(t){ var v = val('out',t); if(v>outTop.value) outTop={time:t,value:v}; });
    var backTop = { time:null, value:0 };
    DIRS.back.baseTimes.forEach(function(t){ var v = val('back',t); if(v>backTop.value) backTop={time:t,value:v}; });

    var recent = await storage.queryLogs({ mode:'all', limit: 250 });

    function buildBars(map, times) {
      map = map || {};
      var maxVal = 0;
      times.forEach(function(t){ var v = map[timeKey(t)] || 0; if(v>maxVal) maxVal=v; });
      return times.map(function(t){
        var v = map[timeKey(t)] || 0;
        var w = maxVal ? Math.round((v/maxVal)*100) : 0;
        return '<div class="bar">' +
          '<div class="lbl">'+escapeHtml(t)+'</div>' +
          '<div class="track"><div class="fill" style="width:'+w+'%"></div></div>' +
          '<div class="num">'+v+'</div>' +
        '</div>';
      }).join('');
    }

    var rows = recent.map(function(e){
      var ts = e.tsMs ? new Date(e.tsMs).toLocaleString() : '';
      var action = (e.action === 'BOOK')
        ? '<span style="color:var(--ok);font-weight:900">BOOK</span>'
        : '<span style="color:var(--danger);font-weight:900">CANCEL</span>';
      var dir = e.dir === 'out' ? 'ขาไป' : (e.dir === 'back' ? 'ขากลับ' : (e.dir||''));
      var route = (e.pickup && e.destination) ? (e.pickup + ' → ' + e.destination) : '';
      return '<tr>'+
        '<td>'+escapeHtml(ts)+'</td>'+
        '<td>'+action+'</td>'+
        '<td>'+escapeHtml(dir)+'</td>'+
        '<td>'+escapeHtml(e.time||'')+'</td>'+
        '<td>'+escapeHtml(route)+'</td>'+
        '<td>'+escapeHtml(e.arriveTime||'')+'</td>'+
        '<td>'+escapeHtml(e.room||'')+'</td>'+
        '<td><b>'+escapeHtml((typeof e.pax==='number')?e.pax:(e.pax||''))+'</b></td>'+
      '</tr>';
    }).join('\n');

    $('view').innerHTML =
      '<section class="card">' +
        '<div class="card-h">' +
          '<div><h2>บันทึก/สถิติ</h2><p class="hint">เดือน <b>'+escapeHtml(monthKey)+'</b> • Export แยก วัน/เดือน/ทั้งหมด ได้</p></div>' +
          '<div class="row"><button class="btn ghost" onclick="window.__goSchedule()">กลับหน้าตาราง</button></div>' +
        '</div>' +
        '<div class="card-b">' +
          '<div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14); margin-bottom: 12px;">' +
            '<div class="card-b">' +
              '<div class="row" style="align-items:flex-end; justify-content:space-between">' +
                '<div class="row" style="flex:1;">' +
                  '<div class="field" style="max-width:230px"><label for="expDay">Export ตามวัน</label><input id="expDay" type="date" /></div>' +
                  '<button class="btn" onclick="window.__exportDayFromInput()">Export วัน</button>' +
                  '<div class="field" style="max-width:230px"><label for="expMonth">Export ตามเดือน</label><input id="expMonth" type="month" /></div>' +
                  '<button class="btn" onclick="window.__exportMonthFromInput()">Export เดือน</button>' +
                '</div>' +
                '<div class="row"><button class="btn" onclick="window.__exportAll()">Export ทั้งหมด</button></div>' +
              '</div>' +
              '<div class="mini">หมายเหตุ: Export วัน/เดือน จะดึง log จาก Firebase ตามช่วงเวลา • ถ้าข้อมูลเยอะอาจใช้เวลาสักครู่</div>' +
            '</div>' +
          '</div>' +

          '<div class="grid">' +
            '<div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14);">' +
              '<div class="card-h" style="border-bottom-color: rgba(131,106,69,.10)"><div><h2 style="font-size:15.5px">สถิติ • ขาไป</h2><p class="hint">เวลาที่จองเยอะสุด: <b>'+(outTop.time||'—')+'</b> ('+outTop.value+' คน)</p></div></div>' +
              '<div class="card-b">'+ buildBars(stats.out, DIRS.out.baseTimes) +'</div>' +
            '</div>' +
            '<div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14);">' +
              '<div class="card-h" style="border-bottom-color: rgba(131,106,69,.10)"><div><h2 style="font-size:15.5px">สถิติ • ขากลับ</h2><p class="hint">เวลาที่จองเยอะสุด: <b>'+(backTop.time||'—')+'</b> ('+backTop.value+' คน)</p></div></div>' +
              '<div class="card-b">'+ buildBars(stats.back, DIRS.back.baseTimes) +'</div>' +
            '</div>' +
          '</div>' +

          '<div class="divider"></div>' +

          '<table>' +
            '<thead><tr><th>เวลา</th><th>Action</th><th>ขา</th><th>รอบ</th><th>เส้นทาง</th><th>ถึง</th><th>ห้อง</th><th>คน</th></tr></thead>' +
            '<tbody>' + (rows || '<tr><td colspan="8" class="mini">ยังไม่มี Log</td></tr>') + '</tbody>' +
          '</table>' +
        '</div>' +
      '</section>';

    var dayEl = $('expDay');
    var monthEl = $('expMonth');
    if(dayEl) dayEl.value = todayKey();
    if(monthEl) monthEl.value = currentMonthKey();

    window.__exportDayFromInput = function(){
      var v = (dayEl && dayEl.value) ? dayEl.value : todayKey();
      doExport('day', v).catch(console.error);
    };
    window.__exportMonthFromInput = function(){
      var v = (monthEl && monthEl.value) ? monthEl.value : currentMonthKey();
      doExport('month', v).catch(console.error);
    };
    window.__exportAll = function(){ doExport('all','').catch(console.error); };

    window.__goSchedule = function(){ setHash('/'); };
  }

  // ============================
  // Router
  // ============================
  async function render() {
    var h = parseHash();
    if(h.path === '/logs') return viewLogs();
    if(h.path === '/book') {
      var dir = h.params.get('dir') || 'out';
      var t = h.params.get('time') || '';
      return viewBooking(dir==='back'?'back':'out', t);
    }
    return viewSchedule();
  }

  // ============================
  // Init
  // ============================
  async function boot() {
    if(!location.hash) location.hash = '#/';
    await storage.initFirebase(); // try firebase first
    window.addEventListener('hashchange', function(){ render().catch(console.error); });
    render().catch(console.error);
  }

  boot().catch(console.error);

})();
</script>
</body>
</html>
