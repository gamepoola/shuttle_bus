<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laya shuttle bus</title>
  <style>
    :root{
      --bg1:#07121f; --bg2:#0b1a2a;
      --text:#f5f0e6; --muted:#cbbfae;
      --gold:#836A45;
      --gold2:#B0A390;
      --line: rgba(131,106,69,.22);
      --shadow: 0 12px 34px rgba(0,0,0,.40);
      --ok:#22c55e;
      --danger:#ff5a5f;
      --yellow:#f2c94c;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(131,106,69,.14), transparent 60%),
        radial-gradient(900px 700px at 90% 20%, rgba(176,163,144,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .wrap{ max-width: 1120px; margin: 0 auto; padding: 18px; }

    header{
      position: sticky; top: 0;
      backdrop-filter: blur(10px);
      background: rgba(7,18,31,.65);
      border-bottom: 1px solid var(--line);
      z-index: 10;
    }

    .brand{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 14px 18px; }
    .brand-left{ display:flex; align-items:center; gap:12px; min-width:0; }

    .mark{
      width: 46px; height: 46px; border-radius: 16px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.14), transparent 55%),
                  linear-gradient(135deg, rgba(131,106,69,.38), rgba(131,106,69,.08));
      border: 1px solid rgba(131,106,69,.35);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight: 900;
      color: var(--gold2);
      letter-spacing: .5px;
      font-size: 18px;
      flex: 0 0 auto;
    }

    h1{ margin:0; font-size: 20px; letter-spacing: .6px; }
    .sub{ margin:2px 0 0 0; color: var(--muted); font-size: 13.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70vw; }

    .nav{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(131,106,69,.22);
      background: rgba(15,36,56,.35);
      color: var(--text);
      font-size: 14px;
      font-weight: 650;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      display:inline-block;
    }
    .chip.active{ border-color: rgba(131,106,69,.55); background: rgba(131,106,69,.14); color: var(--gold2); }

    .card{
      background: linear-gradient(180deg, rgba(15,36,56,.78), rgba(12,29,47,.72));
      border: 1px solid rgba(131,106,69,.18);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: 16px 16px 12px 16px;
      border-bottom: 1px solid rgba(131,106,69,.16);
      display:flex; align-items:flex-end; justify-content:space-between; gap: 12px;
      flex-wrap:wrap;
    }
    .card-h h2{ margin:0; font-size: 17px; letter-spacing:.4px; }
    .card-h .hint{ margin:4px 0 0 0; color: var(--muted); font-size: 13.5px; line-height: 1.5; }
    .card-b{ padding: 14px 16px 16px 16px; }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1.1fr .9fr; } }

    .slots{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 640px){ .slots{ grid-template-columns: 1fr 1fr; } }

    .slot{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(7,18,31,.35);
    }
    .slot .meta{ display:flex; flex-direction:column; gap: 6px; min-width:0; }
    .slot .time{ font-size: 22px; font-weight: 900; letter-spacing:.3px; }
    .slot .seat{ font-size: 15.5px; color: var(--muted); }
    .slot .seat b{ font-size: 20px; color: var(--ok); }
    .slot .seat b.danger{ color: var(--danger); }

    .btn{
      appearance:none;
      border: 1px solid rgba(131,106,69,.35);
      background: rgba(15,36,56,.35);
      color: var(--text);
      padding: 11px 14px;
      border-radius: 16px;
      font-weight: 850;
      letter-spacing: .2px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
      min-width: 110px;
      text-align:center;
      font-size: 15px;
    }
    .btn:hover{ border-color: rgba(131,106,69,.60); background: rgba(15,36,56,.45); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity: .55; cursor:not-allowed; transform:none; }

    /* ปุ่มปิดแล้ว (สีเดิม/เข้ม) */
    .btn.closed{
      background: rgba(15,36,56,.30);
      border-color: rgba(131,106,69,.18);
      color: rgba(245,240,230,.65);
    }

    /* ปุ่มเลือก (สีเหลือง) */
    .btn.pick{
      background: linear-gradient(135deg, rgba(242,201,76,.95), rgba(242,201,76,.65));
      border-color: rgba(242,201,76,.85);
      color: #0b1a2a;
    }
    .btn.pick:hover{
      background: linear-gradient(135deg, rgba(242,201,76,1), rgba(242,201,76,.72));
      border-color: rgba(242,201,76,1);
    }

    .btn.primary{ background: linear-gradient(135deg, rgba(131,106,69,.22), rgba(131,106,69,.12)); border-color: rgba(131,106,69,.55); color: var(--text); }
    .btn.ghost{ background: rgba(15,36,56,.25); border-color: rgba(131,106,69,.22); color: var(--text); }
    .btn.danger{ background: rgba(255,90,95,.10); border-color: rgba(255,90,95,.45); color: #ffb0b3; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }

    .field{ display:flex; flex-direction:column; gap:6px; width: 100%; }
    label{ color: var(--muted); font-size: 13.5px; font-weight: 650; }
    input, select{
      width: 100%;
      padding: 13px 12px;
      border-radius: 16px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(7,18,31,.35);
      color: var(--text);
      outline:none;
      font-size: 17px;
      font-weight: 650;
    }
    select{ cursor:pointer; }
    input:focus, select:focus{ border-color: rgba(131,106,69,.55); box-shadow: 0 0 0 4px rgba(131,106,69,.12); }

    .kpi{
      display:flex; flex-direction:column; gap: 8px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(7,18,31,.35);
    }
    .kpi .big{ font-size: 30px; font-weight: 950; letter-spacing:.2px; color: var(--gold2); }
    .kpi .small{ color: var(--muted); font-size: 13.5px; line-height: 1.55; }

    .divider{ height:1px; background: rgba(131,106,69,.16); margin: 12px 0; }

    .barwrap{ display:grid; gap: 8px; }
    .bar{ display:flex; align-items:center; gap: 10px; padding: 10px; border-radius: 16px; border: 1px solid rgba(131,106,69,.16); background: rgba(7,18,31,.25); }
    .bar .lbl{ width: 66px; color: var(--muted); font-size: 13.5px; font-weight: 700; }
    .bar .track{ flex: 1; height: 12px; border-radius: 999px; background: rgba(131,106,69,.10); overflow:hidden; }
    .bar .fill{ height: 100%; width: 0%; background: linear-gradient(90deg, rgba(131,106,69,.60), rgba(176,163,144,.22)); }
    .bar .num{ width: 62px; text-align:right; color: var(--gold2); font-weight: 900; font-size: 13.5px; }

    .footer-actions{ display:flex; gap: 10px; flex-wrap:wrap; justify-content:flex-end; }

    .pill{ display:inline-flex; align-items:center; gap: 8px; padding: 8px 11px; border-radius: 999px; background: rgba(131,106,69,.10); border: 1px solid rgba(131,106,69,.20); color: var(--muted); font-size: 13.5px; font-weight: 650; }
    .dot{ width: 9px; height: 9px; border-radius: 50%; background: var(--gold); box-shadow: 0 0 0 4px rgba(131,106,69,.12); }

    .mini{
      margin-top: 10px;
      border-top: 1px solid rgba(131,106,69,.16);
      padding-top: 10px;
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.65;
    }

    .note{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(131,106,69,.18);
      background: rgba(7,18,31,.25);
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.6;
    }

    .danger-text{ color: #ffb0b3; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(7,18,31,.88);
      border: 1px solid rgba(131,106,69,.25);
      box-shadow: var(--shadow);
      padding: 12px 14px;
      border-radius: 18px;
      max-width: 92vw;
      width: 620px;
      display:none;
      z-index: 30;
    }
    .toast.show{ display:block; animation: pop .12s ease-out; }
    @keyframes pop{ from{ transform: translateX(-50%) translateY(6px); opacity:.0; } to{ transform: translateX(-50%) translateY(0); opacity:1; } }
    .toast .t{ font-weight: 900; color: var(--text); font-size: 15.5px; }
    .toast .d{ color: var(--muted); font-size: 13.5px; margin-top: 4px; line-height: 1.5; }

    table{ width: 100%; border-collapse: collapse; overflow:hidden; border-radius: 18px; border: 1px solid rgba(131,106,69,.18); background: rgba(7,18,31,.25); }
    th, td{ padding: 11px 11px; font-size: 13px; border-bottom: 1px solid rgba(131,106,69,.14); text-align:left; }
    th{ color: var(--muted); font-weight: 800; }
    tr:last-child td{ border-bottom:none; }
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="brand-left">
        <div class="mark">L</div>
        <div style="min-width:0">
          <h1>Laya shuttle bus</h1>
          <p class="sub" id="statusLine">Loading…</p>
        </div>
      </div>
      <nav class="nav" id="nav"></nav>
    </div>
  </header>

  <main class="wrap" id="view"></main>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="t" id="toastTitle"></div>
    <div class="d" id="toastDesc"></div>
  </div>

  <script>
(function() {
  'use strict';

  // ============================
  // CONFIG
  // ============================
  var CAPACITY_PER_TRIP = 20;

  // Firebase config (provided by user)
  var FIREBASE_CONFIG = {"apiKey": "AIzaSyCaZSHXmDypHwR3oQm3JpFg2mOorWNU_nY", "authDomain": "laya-shuttlebus.firebaseapp.com", "projectId": "laya-shuttlebus", "storageBucket": "laya-shuttlebus.firebasestorage.app", "messagingSenderId": "15563028134", "appId": "1:15563028134:web:505a3c19fcf4a87faba667", "measurementId": "G-DC44DP40G2"};

  // LocalStorage keys (fallback)
  var LS_STATE = 'laya_bus_state_local_v1';
  var LS_LOGS  = 'laya_bus_logs_local_v1';
  var LS_UI    = 'laya_bus_ui_v1';

  // Firestore collection names (match your console screenshot)
  var COL_SLOTS = 'slots';
  var COL_LOGS  = 'logs';
  var COL_STATS = 'stats';

  // Firebase module version (CDN)
  var FB_VER = '10.12.5';

  // ============================
  // Schedule
  // ============================
  var DIRS = {
    out: {
      key: 'out',
      label: 'ขาไป',
      baseTimes: ['11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00'],
      timeline: [
        { key:'HOTEL', name:'Hotel', off: 0 },
        { key:'LAYAN', name:'Layan National Park', off: 5 },
        { key:'LEPHANG', name:'Le Phang Beach', off: 10 },
        { key:'BOAT', name:'Boat Avenue', off: 20 }
      ],
      selectLabel: 'จุดหมายปลายทาง',
      selectable: [
        { key:'LAYAN', name:'Layan National Park' },
        { key:'LEPHANG', name:'Le Phang Beach' },
        { key:'BOAT', name:'Boat Avenue' }
      ]
    },
    back: {
      key: 'back',
      label: 'ขากลับ',
      baseTimes: ['11:30','12:30','13:30','14:30','15:30','16:30','17:30','18:30'],
      timeline: [
        { key:'BOAT', name:'Boat Avenue', off: 0 },
        { key:'LEPHANG', name:'Le Phang Beach', off: 10 },
        { key:'LAYAN', name:'Layan National Park', off: 15 },
        { key:'HOTEL', name:'Hotel', off: 20 }
      ],
      selectLabel: 'จุดรับขึ้นรถ',
      selectable: [
        { key:'BOAT', name:'Boat Avenue' },
        { key:'LEPHANG', name:'Le Phang Beach' },
        { key:'LAYAN', name:'Layan National Park' }
      ]
    }
  };

  // ============================
  // Utils
  // ============================
  function pad2(n) { return String(n).padStart(2,'0'); }
  function timeToMin(t) {
    var p = String(t).split(':'); return (parseInt(p[0],10)*60) + parseInt(p[1],10);
  }
  function minToTime(min) {
    min = ((min % (24*60)) + (24*60)) % (24*60);
    var h = Math.floor(min/60); var m = min%60;
    return pad2(h)+':'+pad2(m);
  }
  function addMin(t, delta) { return minToTime(timeToMin(t) + delta); }

  function todayKey() {
    var d = new Date();
    return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate());
  }
  function monthKeyFromDateStr(dateStr) {
    if(!dateStr) return '';
    return String(dateStr).slice(0,7);
  }
  function currentMonthKey() {
    return monthKeyFromDateStr(todayKey());
  }
  function nowMin() {
    var d = new Date();
    return d.getHours()*60 + d.getMinutes();
  }
  function isClosedToday(baseTime) { return nowMin() >= timeToMin(baseTime); }

  function compareDateStr(a, b) {
    // a,b in YYYY-MM-DD
    if(a === b) return 0;
    return (a < b) ? -1 : 1;
  }

  function isSlotPast(dateStr, baseTime) {
    var today = todayKey();
    var cmp = compareDateStr(dateStr, today);
    if(cmp < 0) return true;         // past date
    if(cmp > 0) return false;        // future date
    return isClosedToday(baseTime);  // today: compare time
  }

  function slotTsMs(dateStr, timeStr) {
    // local time timestamp for the shuttle round (pickup base time)
    try {
      var parts = String(dateStr).split('-');
      var y = parseInt(parts[0],10);
      var mo = parseInt(parts[1],10)-1;
      var da = parseInt(parts[2],10);
      var tm = String(timeStr).split(':');
      var hh = parseInt(tm[0],10);
      var mm = parseInt(tm[1],10);
      return new Date(y, mo, da, hh, mm, 0, 0).getTime();
    } catch(e) {
      return Date.now();
    }
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function toast(title, desc) {
    desc = desc || '';
    var el = document.getElementById('toast');
    document.getElementById('toastTitle').textContent = title;
    document.getElementById('toastDesc').textContent = desc;
    el.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(function(){ el.classList.remove('show'); }, 2600);
  }

  function parseHash() {
    var raw = location.hash || '#/';
    var parts = raw.replace(/^#/, '').split('?');
    var path = parts[0];
    var params = new URLSearchParams(parts[1] || '');
    return { path: path, params: params };
  }
  function setHash(path) { location.hash = '#'+path; }

  function downloadBlob(filename, mime, content) {
    // Robust download for Chrome/Edge/Firefox + fallback for iOS/Safari
    var blob = (content instanceof Blob) ? content : new Blob([content], { type: mime });
    if (window.navigator && window.navigator.msSaveOrOpenBlob) {
      window.navigator.msSaveOrOpenBlob(blob, filename);
      return;
    }
    var url = URL.createObjectURL(blob);

    var ua = (navigator && navigator.userAgent) ? navigator.userAgent : '';
    var isIOS = /iP(ad|hone|od)/.test(ua);
    var isSafari = /^((?!chrome|android).)*safari/i.test(ua);

    // iOS Safari download attribute is unreliable — open in a new tab
    if (isIOS || isSafari) {
      window.open(url, '_blank', 'noopener,noreferrer');
      setTimeout(function(){ URL.revokeObjectURL(url); }, 60000);
      toast('เปิดไฟล์แล้ว', 'ถ้าไม่ดาวน์โหลดอัตโนมัติ ให้กด Share/Save บนหน้าที่เปิดขึ้นมา');
      return;
    }

    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.rel = 'noopener';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(function(){ URL.revokeObjectURL(url); }, 5000);
  }

  function safeKey(s) {
    // Firestore field path safety (avoid '.', '#', '$', '/', '[', ']')
    return String(s || '').replace(/[.#$\/\[\]]/g, '_');
  }

  function timeKey(t) { return 't' + String(t).replace(':',''); }

  function slotDocId(dateStr, dirKey, baseTime) {
    return dateStr + '_' + dirKey + '_' + String(baseTime).replace(':','');
  }

  function calcTimes(dirKey, baseTime, placeKey) {
    var dir = DIRS[dirKey];
    if(!dir || !placeKey) return null;

    if(dirKey === 'out') {
      var dest = dir.timeline.find(function(x){ return x.key === placeKey; });
      if(!dest) return null;
      return {
        pickup: 'Hotel',
        destination: dest.name,
        pickupTime: baseTime,
        arriveTime: addMin(baseTime, dest.off)
      };
    }

    // back
    var pickupStop = dir.timeline.find(function(x){ return x.key === placeKey; });
    var hotelStop = dir.timeline.find(function(x){ return x.key === 'HOTEL'; });
    if(!pickupStop || !hotelStop) return null;

    return {
      pickup: pickupStop.name,
      destination: 'Hotel',
      pickupTime: addMin(baseTime, pickupStop.off),
      arriveTime: addMin(baseTime, hotelStop.off)
    };
  }

  // ============================
  // Local fallback store
  // ============================
  function buildDefaultLocalSlot(dateStr, dirKey, t) {
    return { date: dateStr, dir: dirKey, time: t, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {} };
  }

  function loadLocalState() {
    try {
      var raw = localStorage.getItem(LS_STATE);
      if(!raw) return { slots: {} };
      var parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== 'object') return { slots: {} };
      if(!parsed.slots || typeof parsed.slots !== 'object' || Array.isArray(parsed.slots)) parsed.slots = {};
      return { slots: parsed.slots };
    } catch(e) {
      return { slots: {} };
    }
  }
  function saveLocalState(st) {
    var slots = (st && st.slots && typeof st.slots === 'object') ? st.slots : {};
    localStorage.setItem(LS_STATE, JSON.stringify({ slots: slots }));
  }

  function loadLocalLogs() {
    try {
      var raw = localStorage.getItem(LS_LOGS);
      if(!raw) return [];
      var parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch(e) { return []; }
  }
  function addLocalLog(entry) {
    var logs = loadLocalLogs();
    logs.unshift(entry);
    localStorage.setItem(LS_LOGS, JSON.stringify(logs));
  }

  // ============================
  // Storage abstraction (Firebase preferred, local fallback)
  // ============================
  var storage = (function(){
    var mode = 'local';
    var fb = null; // { db, auth, fs }
    var initError = null;

    function getMode() { return mode; }
    function getInitError() { return initError; }

    async function initFirebase() {
      try {
        var modApp = await import('https://www.gstatic.com/firebasejs/' + FB_VER + '/firebase-app.js');
        var modAuth = await import('https://www.gstatic.com/firebasejs/' + FB_VER + '/firebase-auth.js');
        var modFs = await import('https://www.gstatic.com/firebasejs/' + FB_VER + '/firebase-firestore.js');

        var app = modApp.initializeApp(FIREBASE_CONFIG);
        var auth = modAuth.getAuth(app);

        await modAuth.signInAnonymously(auth);

        var db = modFs.getFirestore(app);

        fb = { db: db, auth: auth, fs: modFs };
        mode = 'firebase';
        initError = null;
        return true;
      } catch(e) {
        mode = 'local';
        fb = null;
        initError = e;
        console.warn('Firebase init failed, fallback to local:', e);
        toast('Firebase ใช้งานไม่ได้', 'สลับเป็นโหมด Local ชั่วคราว');
        return false;
      }
    }

    function isQuotaError(e) {
      var msg = (e && e.message) ? String(e.message) : '';
      var code = (e && e.code) ? String(e.code) : '';
      return code === 'resource-exhausted' || msg.includes('Quota') || msg.includes('resource-exhausted') || msg.includes('429');
    }


    function normalizeSlotData(data) {
      data = data || {};
      // ensure bookings is a plain object
      if(!data.bookings || typeof data.bookings !== 'object' || Array.isArray(data.bookings)) data.bookings = {};
      var b = data.bookings;

      // Some legacy writes may have stored bookings as top-level fields like "bookings.A105"
      // Reconstruct them into data.bookings so the UI can show booked rooms.
      var keys = Object.keys(data);
      for(var i=0;i<keys.length;i++) {
        var k = keys[i];
        if(k.indexOf('bookings.') === 0) {
          var rk = k.slice('bookings.'.length);
          if(rk && b[rk] === undefined && data[k] !== undefined) b[rk] = data[k];
        }
      }
      return data;
    }
    async function getSlot(dateStr, dirKey, timeStr) {
      var id = slotDocId(dateStr, dirKey, timeStr);

      if(mode !== 'firebase') {
        var st = loadLocalState();
        var slot = st.slots[id];
        if(!slot) {
          slot = { date: dateStr, dir: dirKey, time: timeStr, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {} };
          st.slots[id] = slot;
          saveLocalState(st);
        }
        return JSON.parse(JSON.stringify(slot));
      }

      try {
        var fs = fb.fs;
        var ref = fs.doc(fb.db, COL_SLOTS, id);
        var snap = await fs.getDoc(ref);
        if(!snap.exists()) {
          var def = { date: dateStr, dir: dirKey, time: timeStr, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {}, updatedAt: fs.serverTimestamp() };
          await fs.setDoc(ref, def, { merge: true });
          def.updatedAt = null;
          return def;
        }
        var data = Object.assign({}, snap.data());
        data = normalizeSlotData(data);
        return data;
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) {
          mode = 'local';
          toast('Quota Firebase เต็ม', 'สลับเป็น Local ชั่วคราว');
          return getSlot(dateStr, dirKey, timeStr);
        }
        throw e;
      }
    }

    async function listSlots(dateStr, dirKey) {
      var times = DIRS[dirKey].baseTimes.slice();
      var out = [];
      for(var i=0;i<times.length;i++) {
        var t = times[i];
        var s = await getSlot(dateStr, dirKey, t);
        out.push({ time: t, capacity: s.capacity || CAPACITY_PER_TRIP, available: (typeof s.available==='number'? s.available : CAPACITY_PER_TRIP) });
      }
      return out;
    }

    async function book(dateStr, dirKey, timeStr, roomRaw, pax, placeKey, timesInfo) {
      var room = String(roomRaw || '').trim();
      if(!room) return { ok:false, msg:'กรุณาใส่เลขห้อง' };
      var roomK = safeKey(room);

      if(mode !== 'firebase') {
        var st = loadLocalState();
        var id = slotDocId(dateStr, dirKey, timeStr);
        var slot = st.slots[id] || { date: dateStr, dir: dirKey, time: timeStr, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {} };
        if(slot.bookings[roomK] && slot.bookings[roomK].pax > 0) return { ok:false, msg:'ห้องนี้จองแล้ว (กันการกดซ้ำ)' };
        if(pax > slot.available) return { ok:false, msg:'ที่นั่งไม่พอ' };
        slot.bookings[roomK] = {
          room: room, pax: pax, placeKey: placeKey,
          pickup: timesInfo.pickup, destination: timesInfo.destination,
          pickupTime: timesInfo.pickupTime, arriveTime: timesInfo.arriveTime,
          tsMs: Date.now()
        };
        slot.available -= pax;
        st.slots[id] = slot;
        saveLocalState(st);
        addLocalLog({ action:'BOOK', pax:pax, room:room, time:timeStr, dir:dirKey, date:dateStr, slotTsMs: slotTsMs(dateStr, timeStr), tsMs: Date.now() });
        return { ok:true };
      }

      try {
        var fs = fb.fs;
        var db = fb.db;
        var slotId = slotDocId(dateStr, dirKey, timeStr);
        var slotRef = fs.doc(db, COL_SLOTS, slotId);

        var monthKey = monthKeyFromDateStr(dateStr);
        var statsRef = fs.doc(db, COL_STATS, monthKey);
        var logRef = fs.doc(fs.collection(db, COL_LOGS)); // auto-id

        await fs.runTransaction(db, async function(tx){
          var snap = await tx.get(slotRef);
          var data;
          if(!snap.exists()) {
            data = { date: dateStr, dir: dirKey, time: timeStr, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {} };
            tx.set(slotRef, Object.assign({}, data, { updatedAt: fs.serverTimestamp() }), { merge: true });
          } else {
            data = snap.data();
          }

          var capacity = (typeof data.capacity==='number') ? data.capacity : CAPACITY_PER_TRIP;
          var available = (typeof data.available==='number') ? data.available : capacity;
          var bookings = data.bookings || {};

          var existing = bookings[roomK];
          if(existing && existing.pax > 0) throw new Error('ห้องนี้จองแล้ว (กันการกดซ้ำ)');
          if(pax > available) throw new Error('ที่นั่งไม่พอ');

          var bookingObj = {
            room: room, pax: pax, placeKey: placeKey,
            pickup: timesInfo.pickup, destination: timesInfo.destination,
            pickupTime: timesInfo.pickupTime, arriveTime: timesInfo.arriveTime,
            tsMs: Date.now()
          };

          var upd = { available: (available - pax), updatedAt: fs.serverTimestamp(), bookings: {} };
          upd.bookings[roomK] = bookingObj;
          tx.set(slotRef, upd, { merge: true });
          var statUpd = { updatedAt: fs.serverTimestamp(), meta: {
            logs: fs.increment(1),
            bookEntries: fs.increment(1),
            bookPax: fs.increment(pax)
          } };
          statUpd[dirKey] = {};
          statUpd[dirKey][timeKey(timeStr)] = fs.increment(pax);
          tx.set(statsRef, statUpd, { merge: true });
tx.set(logRef, {
            action: 'BOOK', pax: pax, room: room, time: timeStr, dir: dirKey,
            date: dateStr, month: monthKey,
            slotTsMs: slotTsMs(dateStr, timeStr),
            placeKey: placeKey,
            pickup: timesInfo.pickup, destination: timesInfo.destination,
            pickupTime: timesInfo.pickupTime, arriveTime: timesInfo.arriveTime,
            tsMs: Date.now(),
            ts: fs.serverTimestamp()
          });
        });

        return { ok:true };
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) {
          mode = 'local';
          toast('Quota Firebase เต็ม', 'สลับเป็น Local ชั่วคราว');
          return book(dateStr, dirKey, timeStr, roomRaw, pax, placeKey, timesInfo);
        }
        return { ok:false, msg: (e && e.message) ? e.message : 'จองไม่สำเร็จ' };
      }
    }

    async function cancel(dateStr, dirKey, timeStr, roomRaw, pax) {
      var room = String(roomRaw || '').trim();
      if(!room) return { ok:false, msg:'กรุณาใส่เลขห้อง' };
      var roomK = safeKey(room);

      if(mode !== 'firebase') {
        var st = loadLocalState();
        var id = slotDocId(dateStr, dirKey, timeStr);
        var slot = st.slots[id];
        if(!slot) return { ok:false, msg:'ไม่พบรอบเวลานี้' };
        var existing = slot.bookings[roomK];
        var booked = existing ? (existing.pax || 0) : 0;
        if(booked <= 0) return { ok:false, msg:'ห้องนี้ยังไม่มีการจองในรอบนี้' };
        if(pax > booked) return { ok:false, msg:'ยกเลิกเกินจำนวนที่จองไว้' };
        var left = booked - pax;
        if(left === 0) delete slot.bookings[roomK];
        else slot.bookings[roomK].pax = left;
        slot.available = Math.min(slot.capacity || CAPACITY_PER_TRIP, (slot.available || 0) + pax);
        saveLocalState(st);
        addLocalLog({ action:'CANCEL', pax:pax, room:room, time:timeStr, dir:dirKey, date:dateStr, slotTsMs: slotTsMs(dateStr, timeStr), tsMs: Date.now() });
        return { ok:true };
      }

      try {
        var fs = fb.fs;
        var db = fb.db;
        var slotId = slotDocId(dateStr, dirKey, timeStr);
        var slotRef = fs.doc(db, COL_SLOTS, slotId);
        var monthKey = monthKeyFromDateStr(dateStr);
        var statsRef = fs.doc(db, COL_STATS, monthKey);
        var logRef = fs.doc(fs.collection(db, COL_LOGS));

        await fs.runTransaction(db, async function(tx){
          var snap = await tx.get(slotRef);
          if(!snap.exists()) throw new Error('ไม่พบรอบเวลานี้');

          var data = snap.data() || {};
          var capacity = (typeof data.capacity==='number') ? data.capacity : CAPACITY_PER_TRIP;
          var available = (typeof data.available==='number') ? data.available : capacity;

          // ✅ Robust bookings map (supports legacy data)
          var bookings = {};
          if(data.bookings && typeof data.bookings === 'object' && !Array.isArray(data.bookings)) {
            bookings = Object.assign({}, data.bookings);
          }
          Object.keys(data).forEach(function(k){
            if(k.indexOf('bookings.') === 0) {
              var rk = k.slice('bookings.'.length);
              if(bookings[rk] === undefined && data[k] !== undefined) bookings[rk] = data[k];
            }
          });

          // ✅ Find booking key (case-insensitive)
          var roomNorm = String(room || '').trim();
          var roomUpper = roomNorm.toUpperCase();
          var candidates = [safeKey(roomUpper), safeKey(roomNorm), roomUpper, roomNorm];

          var foundKey = null;
          for(var i=0;i<candidates.length;i++){
            var ck = candidates[i];
            if(ck && bookings[ck] !== undefined) { foundKey = ck; break; }
          }
          if(!foundKey) {
            Object.keys(bookings).some(function(k){
              if(String(k).toUpperCase() === roomUpper) { foundKey = k; return true; }
              var obj = bookings[k];
              if(obj && typeof obj === 'object' && obj.room && String(obj.room).toUpperCase() === roomUpper) { foundKey = k; return true; }
              return false;
            });
          }
          if(!foundKey) throw new Error('ห้องนี้ยังไม่มีการจองในรอบนี้');

          var existing = bookings[foundKey];
          var booked = 0;
          if(existing && typeof existing === 'object') booked = Number(existing.pax || existing.people || 0);
          else if(typeof existing === 'number') booked = Number(existing);

          if(!Number.isFinite(booked) || booked <= 0) throw new Error('ห้องนี้ยังไม่มีการจองในรอบนี้');
          if(pax > booked) throw new Error('ยกเลิกเกินจำนวนที่จองไว้');

          var left = booked - pax;

          // Build cleaned bookings map and overwrite the whole map in Firestore (so deletions always apply)
          var newBookings = Object.assign({}, bookings);
          if(left === 0) {
            // ✅ Tombstone: prevent legacy top-level field like "bookings.A111" from reappearing on next read
            // (We keep pax=0 so UI won't show it, and booking can be re-created later.)
            if(existing && typeof existing === 'object') {
              newBookings[foundKey] = Object.assign({}, existing, { pax: 0, room: existing.room || roomNorm, _tombstone: true, tsMs: Date.now() });
            } else {
              newBookings[foundKey] = { room: roomNorm, pax: 0, _tombstone: true, tsMs: Date.now() };
            }
          } else {
            if(existing && typeof existing === 'object') {
              newBookings[foundKey] = Object.assign({}, existing, { pax: left, room: existing.room || roomNorm });
            } else {
              newBookings[foundKey] = { room: roomNorm, pax: left };
            }
          }

          // Update seats + cleaned bookings
          tx.update(slotRef, {
            available: Math.min(capacity, available + pax),
            bookings: newBookings,
            updatedAt: fs.serverTimestamp()
          });

          // Best-effort cleanup for legacy dotted-field booking (if any) so UI won't re-add it
          if(left === 0 && fs.FieldPath) {
            try {
              tx.update(slotRef, new fs.FieldPath('bookings.' + foundKey), fs.deleteField());
            } catch(_e) {}
          }

          var statUpd2 = { updatedAt: fs.serverTimestamp(), meta: { logs: fs.increment(1), cancelEntries: fs.increment(1) } };
          tx.set(statsRef, statUpd2, { merge:true });

          tx.set(logRef, {
            action: 'CANCEL',
            pax: pax,
            room: roomNorm,
            time: timeStr,
            dir: dirKey,
            date: dateStr,
            month: monthKey,
            slotTsMs: slotTsMs(dateStr, timeStr),
            tsMs: Date.now(),
            ts: fs.serverTimestamp()
          });
        });

        return { ok:true };
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) {
          mode = 'local';
          toast('Quota Firebase เต็ม', 'สลับเป็น Local ชั่วคราว');
          return cancel(dateStr, dirKey, timeStr, roomRaw, pax);
        }
        return { ok:false, msg: (e && e.message) ? e.message : 'ยกเลิกไม่สำเร็จ' };
      }
    }

    function normalizeStatsDoc(data) {
      data = data || {};
      var out = (data.out && typeof data.out === 'object' && !Array.isArray(data.out)) ? data.out : {};
      var back = (data.back && typeof data.back === 'object' && !Array.isArray(data.back)) ? data.back : {};
      var meta = (data.meta && typeof data.meta === 'object' && !Array.isArray(data.meta)) ? data.meta : {};
      // Support legacy dotted field names e.g. "out.t1500" or "meta.logs"
      Object.keys(data).forEach(function(k){
        if(k.indexOf('out.') === 0) out[k.slice(4)] = data[k];
        else if(k.indexOf('back.') === 0) back[k.slice(5)] = data[k];
        else if(k.indexOf('meta.') === 0) meta[k.slice(5)] = data[k];
      });
      return { out: out, back: back, meta: meta };
    }

    async function getStatsMonth(monthKey) {
      if(mode !== 'firebase') {
        var logsAll = loadLocalLogs();
        var logsMonth = logsAll.filter(function(e){ return e && monthKeyFromDateStr(e.date) === monthKey; });

        var out = { out: {}, back: {}, meta: {
          monthLogs: logsMonth.length,
          totalLogs: logsAll.length,
          monthBookEntries: logsMonth.filter(function(e){ return e && e.action === 'BOOK'; }).length,
          monthCancelEntries: logsMonth.filter(function(e){ return e && e.action === 'CANCEL'; }).length
        } };

        Object.keys(DIRS).forEach(function(dk){
          DIRS[dk].baseTimes.forEach(function(t){ out[dk][timeKey(t)] = 0; });
        });

        logsMonth.forEach(function(e){
          if(!e || e.action !== 'BOOK') return;
          if(out[e.dir] && out[e.dir][timeKey(e.time)] !== undefined) out[e.dir][timeKey(e.time)] += (e.pax||0);
        });

        return out;
      }

      try {
        var fs = fb.fs;
        var ref = fs.doc(fb.db, COL_STATS, monthKey);
        var snap = await fs.getDoc(ref);
        
if(!snap.exists()) return { out:{}, back:{}, meta:{} };
        var data = snap.data() || {};
        return normalizeStatsDoc(data);
} catch(e) {
        console.error(e);
        if(isQuotaError(e)) { mode='local'; toast('Quota Firebase เต็ม','สลับเป็น Local ชั่วคราว'); return getStatsMonth(monthKey); }
        return { out:{}, back:{}, meta:{} };
      }
    }


    function rangeMsForDay(dateStr) {
      var parts = String(dateStr).split('-');
      var y = parseInt(parts[0],10); var m = parseInt(parts[1],10)-1; var d = parseInt(parts[2],10);
      var start = new Date(y,m,d,0,0,0,0).getTime();
      var end = new Date(y,m,d+1,0,0,0,0).getTime();
      return { start:start, end:end };
    }
    function rangeMsForMonth(monthStr) {
      var parts = String(monthStr).split('-');
      var y = parseInt(parts[0],10); var m = parseInt(parts[1],10)-1;
      var start = new Date(y,m,1,0,0,0,0).getTime();
      var end = new Date(y,m+1,1,0,0,0,0).getTime();
      return { start:start, end:end };
    }

    async function queryLogs(opts) {
      opts = opts || {};
      var modeQ = opts.mode || 'all';
      var limitN = opts.limit || 250;
      if(limitN < 1) limitN = 250;

      if(mode !== 'firebase') {
        var logs = loadLocalLogs();
        if(modeQ === 'day') logs = logs.filter(function(e){ return e && e.date === opts.value; });
        if(modeQ === 'month') logs = logs.filter(function(e){ return monthKeyFromDateStr(e.date) === opts.value; });
        // sort by shuttle time (slotTsMs) then created time (tsMs)
        logs.sort(function(a,b){
          var ax = (a && typeof a.slotTsMs === 'number') ? a.slotTsMs : (a && typeof a.tsMs === 'number' ? a.tsMs : 0);
          var bx = (b && typeof b.slotTsMs === 'number') ? b.slotTsMs : (b && typeof b.tsMs === 'number' ? b.tsMs : 0);
          return bx - ax;
        });
        return logs.slice(0, limitN);
      }

      try {
        var fs = fb.fs;
        var db = fb.db;
        var col = fs.collection(db, COL_LOGS);
        var out = [];

        function pushUnique(arr, item) {
          if(!item) return;
          var key = String(item.action||'') + '|' + String(item.date||'') + '|' + String(item.dir||'') + '|' + String(item.time||'') + '|' + String(item.room||'') + '|' + String(item.tsMs||'');
          if(!pushUnique._seen) pushUnique._seen = {};
          if(pushUnique._seen[key]) return;
          pushUnique._seen[key] = true;
          arr.push(item);
        }

        if(modeQ === 'day') {
          var r = rangeMsForDay(opts.value);
          // Prefer querying by slotTsMs (shuttle datetime) so future bookings export correctly
          var q1 = fs.query(col,
            fs.where('slotTsMs','>=', r.start),
            fs.where('slotTsMs','<',  r.end),
            fs.orderBy('slotTsMs','desc'),
            fs.limit(limitN)
          );
          var snaps1 = await fs.getDocs(q1);
          snaps1.forEach(function(docSnap){ pushUnique(out, docSnap.data()); });

          // Fallback for legacy logs that don't have slotTsMs
          if(out.length < limitN) {
            var q2 = fs.query(col, fs.where('date','==', opts.value), fs.limit(limitN - out.length));
            var snaps2 = await fs.getDocs(q2);
            snaps2.forEach(function(docSnap){ pushUnique(out, docSnap.data()); });
          }

        } else if(modeQ === 'month') {
          var rm = rangeMsForMonth(opts.value);
          var q3 = fs.query(col,
            fs.where('slotTsMs','>=', rm.start),
            fs.where('slotTsMs','<',  rm.end),
            fs.orderBy('slotTsMs','desc'),
            fs.limit(limitN)
          );
          var snaps3 = await fs.getDocs(q3);
          snaps3.forEach(function(docSnap){ pushUnique(out, docSnap.data()); });

          if(out.length < limitN) {
            var q4 = fs.query(col, fs.where('month','==', opts.value), fs.limit(limitN - out.length));
            var snaps4 = await fs.getDocs(q4);
            snaps4.forEach(function(docSnap){ pushUnique(out, docSnap.data()); });
          }

        } else {
          var q5 = fs.query(col, fs.orderBy('tsMs','desc'), fs.limit(limitN));
          var snaps5 = await fs.getDocs(q5);
          snaps5.forEach(function(docSnap){ pushUnique(out, docSnap.data()); });
        }

        out.sort(function(a,b){
          var ax = (a && typeof a.slotTsMs === 'number') ? a.slotTsMs : (a && typeof a.tsMs === 'number' ? a.tsMs : 0);
          var bx = (b && typeof b.slotTsMs === 'number') ? b.slotTsMs : (b && typeof b.tsMs === 'number' ? b.tsMs : 0);
          return bx - ax;
        });

        return out;
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) { mode='local'; toast('Quota Firebase เต็ม','สลับเป็น Local ชั่วคราว'); return queryLogs(opts); }
        return [];
      }
    }

    async function resetDay(dateStr) {
      if(mode !== 'firebase') {
        var st = loadLocalState();
        Object.keys(DIRS).forEach(function(dirKey){
          DIRS[dirKey].baseTimes.forEach(function(t){
            var id = slotDocId(dateStr, dirKey, t);
            st.slots[id] = buildDefaultLocalSlot(dateStr, dirKey, t);
          });
        });
        saveLocalState(st);
        return true;
      }
      try {
        var fs = fb.fs;
        var db = fb.db;
        var promises = [];
        Object.keys(DIRS).forEach(function(dirKey){
          DIRS[dirKey].baseTimes.forEach(function(t){
            var id = slotDocId(dateStr, dirKey, t);
            var ref = fs.doc(db, COL_SLOTS, id);
            promises.push(fs.setDoc(ref, { date: dateStr, dir: dirKey, time: t, capacity: CAPACITY_PER_TRIP, available: CAPACITY_PER_TRIP, bookings: {}, updatedAt: fs.serverTimestamp() }, { merge:true }));
          });
        });
        await Promise.all(promises);
        return true;
      } catch(e) {
        console.error(e);
        if(isQuotaError(e)) { mode='local'; toast('Quota Firebase เต็ม','สลับเป็น Local ชั่วคราว'); return resetDay(dateStr); }
        return false;
      }
    }

    return {
      initFirebase: initFirebase,
      getMode: getMode,
      getInitError: getInitError,
      getSlot: getSlot,
      listSlots: listSlots,
      book: book,
      cancel: cancel,
      getStatsMonth: getStatsMonth,
      queryLogs: queryLogs,
      resetDay: resetDay
    };
  })();

  // ============================
  // UI helpers
  // ============================
  function $(id) { return document.getElementById(id); }

  function renderNav(activeKey) {
    var nav = $('nav');
    nav.innerHTML = '';
    var items = [
      { key:'/', label:'ตารางเวลา', href:'#/' },
      { key:'/logs', label:'บันทึก/สถิติ', href:'#/logs' }
    ];
    items.forEach(function(it){
      var a = document.createElement('a');
      a.href = it.href;
      a.className = 'chip' + (activeKey===it.key ? ' active' : '');
      a.textContent = it.label;
      nav.appendChild(a);
    });
  }

  function loadUi() {
    try {
      var raw = localStorage.getItem(LS_UI);
      var today = todayKey();
      if(!raw) return { dir:'out', date: today };
      var p = JSON.parse(raw);
      var dir = (p && p.dir === 'back') ? 'back' : 'out';
      var date = (p && typeof p.date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(p.date)) ? p.date : today;
      return { dir: dir, date: date };
    } catch(e) { return { dir:'out', date: todayKey() }; }
  }
  function saveUi(ui) { localStorage.setItem(LS_UI, JSON.stringify(ui)); }

  // ============================
  // Excel export
  // ============================
  function buildExcelHtml(logs) {
    var rows = logs.map(function(e){
      var ts = e.tsMs ? new Date(e.tsMs).toLocaleString() : '';
      var action = e.action || '';
      var dir = e.dir === 'out' ? 'ขาไป' : (e.dir === 'back' ? 'ขากลับ' : (e.dir || ''));
      var time = e.time || '';
      var room = e.room || '';
      var pax = (typeof e.pax === 'number') ? e.pax : (e.pax || '');
      var pickup = e.pickup || '';
      var destination = e.destination || '';
      var pickupTime = e.pickupTime || '';
      var arriveTime = e.arriveTime || '';
      var date = e.date || '';
      return '\n<tr>' +
        '<td>' + escapeHtml(ts) + '</td>' +
        '<td>' + escapeHtml(date) + '</td>' +
        '<td>' + escapeHtml(action) + '</td>' +
        '<td>' + escapeHtml(dir) + '</td>' +
        '<td>' + escapeHtml(time) + '</td>' +
        '<td>' + escapeHtml(room) + '</td>' +
        '<td>' + escapeHtml(pax) + '</td>' +
        '<td>' + escapeHtml(pickup) + '</td>' +
        '<td>' + escapeHtml(destination) + '</td>' +
        '<td>' + escapeHtml(pickupTime) + '</td>' +
        '<td>' + escapeHtml(arriveTime) + '</td>' +
      '</tr>';
    }).join('\n');

    return (
      '<!doctype html>\n<html>\n<head>\n<meta charset="UTF-8" />\n</head>\n<body>' +
      '<table border="1">' +
      '<thead><tr>' +
      '<th>Timestamp</th><th>Date</th><th>Action</th><th>Direction</th><th>Time</th><th>Room</th><th>Pax</th>' +
      '<th>Pickup</th><th>Destination</th><th>Pickup time</th><th>Arrival time</th>' +
      '</tr></thead>' +
      '<tbody>' + rows + '</tbody>' +
      '</table>' +
      '</body></html>'
    );
  }

  async function doExport(mode, value) {
    // ✅ Export reliability: smaller limits + clear feedback
    var limitN = (mode === 'day') ? 5000 : (mode === 'month' ? 20000 : 20000);
    // iOS/Safari: ต้องเปิดแท็บใหม่ก่อน (กัน popup ถูกบล็อกหลัง await)
    var ua = (navigator && navigator.userAgent) ? navigator.userAgent : '';
    var isIOS = /iP(ad|hone|od)/.test(ua);
    var isSafari = /^((?!chrome|android).)*safari/i.test(ua);
    var preWin = null;
    if(isIOS || isSafari) {
      try { preWin = window.open('about:blank', '_blank', 'noopener,noreferrer'); } catch(e) { preWin = null; }
    }
    toast('กำลังเตรียมไฟล์', 'โปรดรอสักครู่…');

    var logs;
    if(mode === 'day') logs = await storage.queryLogs({ mode:'day', value:value, limit: limitN });
    else if(mode === 'month') logs = await storage.queryLogs({ mode:'month', value:value, limit: limitN });
    else logs = await storage.queryLogs({ mode:'all', limit: limitN });

    if(!logs || logs.length === 0) {
      toast('ไม่มีข้อมูล', 'ไม่พบ Log ในช่วงที่เลือก');
      return;
    }

    var html = buildExcelHtml(logs);
    var suffix = (mode === 'day') ? value : (mode === 'month' ? value : ('all-' + todayKey()));
    var filename = 'laya-shuttle-logs-' + suffix + '.xls';
    var mime = 'application/vnd.ms-excel;charset=utf-8';
    var blob = new Blob(['\ufeff' + html], { type: mime });

    if(preWin) {
      // ใส่ไฟล์ลงแท็บที่เปิดไว้แล้ว
      var url = URL.createObjectURL(blob);
      try { preWin.location.href = url; } catch(e) { window.location.href = url; }
      setTimeout(function(){ URL.revokeObjectURL(url); }, 60000);
      toast('เปิดไฟล์แล้ว', 'ถ้าไม่ดาวน์โหลดอัตโนมัติ ให้กด Share/Save บนหน้าที่เปิดขึ้นมา');
      return;
    }

    downloadBlob(filename, mime, blob);

    if(logs.length >= limitN) {
      toast('Export เสร็จแล้ว', 'หมายเหตุ: ส่งออกสูงสุด ' + limitN + ' รายการ (ถ้าข้อมูลเยอะ แนะนำ Export รายวัน/รายเดือน)');
    } else {
      toast('เริ่มดาวน์โหลดไฟล์', 'ถ้าไม่ดาวน์โหลดอัตโนมัติ ให้ดูแท็บใหม่/หน้าดาวน์โหลดของเบราว์เซอร์');
    }
  }// ============================
  // Views
  // ============================
  function setStatusLine() {
    var el = document.getElementById('statusLine');
    if(!el) return;
    var mode = storage.getMode();
    var err = (storage.getInitError ? storage.getInitError() : null);

    if(err && mode !== 'firebase') {
      el.textContent = 'Firebase state error (ใช้ Local แทน)';
      return;
    }
    if(mode === 'firebase') {
      el.textContent = 'Realtime: ข้อมูลที่นั่ง + Log อยู่บน Firebase (Export เป็น Excel ได้)';
      return;
    }
    el.textContent = 'Local: ข้อมูลที่นั่ง + Log อยู่ในเครื่องนี้ (Export เป็น Excel ได้)';
  }
  async function viewSchedule() {
    renderNav('/');
    setStatusLine();

    var ui = loadUi();
    var date = ui.date || todayKey();
    var dirKey = ui.dir;
    var mode = storage.getMode();
    var monthKey = monthKeyFromDateStr(date);

    var slots = await storage.listSlots(date, dirKey);

    // Stats (monthly, based on BOOK total pax)
    var statsMonth = await storage.getStatsMonth(monthKey);
    var meta = (statsMonth && statsMonth.meta) ? statsMonth.meta : {};
    var perObj = (statsMonth && statsMonth[dirKey]) ? statsMonth[dirKey] : {};

    var baseTimes = DIRS[dirKey].baseTimes.slice();
    var topTime = '—';
    var topValue = 0;
    var vals = [];
    baseTimes.forEach(function(t){
      var v = Number(perObj[timeKey(t)] || 0);
      vals.push(v);
      if(v > topValue) { topValue = v; topTime = t; }
    });
    var maxVal = Math.max.apply(null, vals.concat([0]));

    var barsHtml = baseTimes.map(function(t){
      var v = Number(perObj[timeKey(t)] || 0);
      var w = maxVal ? Math.round((v/maxVal)*100) : 0;
      return '<div class="bar">' +
        '<div class="lbl">' + escapeHtml(t) + '</div>' +
        '<div class="track"><div class="fill" style="width:' + w + '%"></div></div>' +
        '<div class="num">' + v + '</div>' +
      '</div>';
    }).join('');

    var cardsHtml = slots.map(function(s){
      var closed = isSlotPast(date, s.time);
      var isFull = (s.available === 0);
      // ✅ Past time: show grey style only (still clickable)
      var btnLabel = isFull ? 'ดู' : 'เลือก';
      var btnKind = (isFull || closed) ? 'closed' : 'pick';
      var availClass = isFull ? 'danger' : '';
      return '<div class="slot">' +
        '<div class="meta">' +
          '<div class="time">' + escapeHtml(s.time) + '</div>' +
          '<div class="seat">ที่นั่งว่าง: <b class="' + availClass + '">' + s.available + '</b> / ' + s.capacity + '</div>' +
          (closed ? '<div style="color: rgba(245,240,230,.55)">• ปิดทำรายการ</div>' : '') +
        '</div>' +
        '<button class="btn ' + btnKind + '" onclick="window.__openBooking(\''+dirKey+'\',\''+s.time+'\')">' + btnLabel + '</button>' +
      '</div>';
    }).join('');

    var dirLabel = (dirKey === 'back') ? 'ขากลับ' : 'ขาไป';
    var monthLogsVal = (meta.logs!==undefined && meta.logs!==null) ? meta.logs : meta.monthLogs;
    var monthLogsText = (monthLogsVal===undefined || monthLogsVal===null) ? '—' : String(monthLogsVal);
    var totalLogsVal = (meta.totalLogs!==undefined && meta.totalLogs!==null) ? meta.totalLogs : monthLogsVal;
    var totalLogsText = (totalLogsVal===undefined || totalLogsVal===null) ? '—' : String(totalLogsVal);

    var right = '';
    right += '<section class="card">';
    right += '<div class="card-h">' +
      '<div><h2>สถิติจาก Log</h2>' +
      '<p class="hint">โหมด: <b>' + dirLabel + '</b> • เดือน <b>' + monthKey + '</b> (ยอด BOOK รวม)</p></div>' +
    '</div>';
    right += '<div class="card-b">';
    right += '<div class="kpi">' +
      '<div class="big">' + escapeHtml(topTime) + '</div>' +
      '<div class="small">ยอดจองรวมสูงสุด • <b>' + topValue + '</b> คน</div>' +
      '<div class="divider"></div>' +
      '<div class="small">Log เดือนนี้โหลด: <b>' + escapeHtml(monthLogsText) + '</b> รายการ • Log ทั้งหมด: <b>' + escapeHtml(totalLogsText) + '</b></div>' +
    '</div>';
    right += '<div style="height:12px"></div>';
    right += '<div class="barwrap">' + barsHtml + '</div>';
    right += '<div class="divider"></div>';
    right += '<div class="footer-actions">' +
      '<button class="btn ghost" onclick="window.__exportDay()">Export วันนี้</button>' +
      '<button class="btn ghost" onclick="window.__exportMonth()">Export เดือนนี้</button>' +
      '<button class="btn ghost" onclick="window.__exportAll()">Export ทั้งหมด</button>' +
    '</div>';
    right += '<div style="height:10px"></div>';
    right += '<div class="footer-actions">' +
      '<button class="btn danger" onclick="window.__resetSeats()">รีเซ็ตที่นั่ง (วันนี้)</button>' +
    '</div>';
    right += '</div></section>';

    $('view').innerHTML =
      '<div class="grid">' +
        '<section class="card">' +
          '<div class="card-h">' +
            '<div><h2>ตารางเวลาเดินรถ</h2><p class="hint">เลือก <b>ขาไป/ขากลับ</b> แล้วกด “เลือก” เพื่อไปหน้าเลือกปลายทาง/จุดรับ</p></div>' +
            '<div class="row">' +
              '<div class="field" style="width:190px;max-width:190px"><label for="datePick">วันที่เดินรถ</label><input id="datePick" type="date" value="'+escapeHtml(date)+'" min="'+escapeHtml(todayKey())+'" /></div>' +
              '<span class="pill"><span class="dot"></span> ' + (mode==='firebase' ? 'Firebase' : 'Local') + '</span>' +
              '<button class="chip ' + (dirKey==='out'?'active':'') + '" onclick="window.__setDir(\'out\')">ขาไป</button>' +
              '<button class="chip ' + (dirKey==='back'?'active':'') + '" onclick="window.__setDir(\'back\')">ขากลับ</button>' +
            '</div>' +
          '</div>' +
          '<div class="card-b"><div class="slots">' + cardsHtml + '</div>' +
            '<div class="mini"><b>Daily reset:</b> ที่นั่งรีเซ็ตทุกวัน • <b>Past time:</b> รอบที่ปิดแล้วแสดงเป็นสีเทา (ยังจอง/ยกเลิกได้)</div>' +
          '</div>' +
        '</section>' +
        right +
      '</div>';

    var dp = $('datePick');
    if(dp) {
      dp.value = date;
      dp.min = todayKey();
      dp.addEventListener('change', function(){
        var v = dp.value;
        if(!/^\d{4}-\d{2}-\d{2}$/.test(v)) return;
        var ui2 = loadUi();
        ui2.date = v;
        saveUi(ui2);
        render().catch(console.error);
      });
    }

    window.__setDir = function(d){
      var ui2 = loadUi();
      ui2.dir = (d==='back') ? 'back' : 'out';
      saveUi(ui2);
      render().catch(console.error);
    };

    window.__openBooking = function(d, t){
      setHash('/book?date=' + encodeURIComponent(date) + '&dir=' + encodeURIComponent(d) + '&time=' + encodeURIComponent(t));
    };

    window.__exportDay = function(){ doExport('day', date).catch(console.error); };
    window.__exportMonth = function(){ doExport('month', monthKeyFromDateStr(date)).catch(console.error); };
    window.__exportAll = function(){ doExport('all','').catch(console.error); };

    window.__resetSeats = function(){
      if(!confirm('ต้องการรีเซ็ตที่นั่งของวันนี้ (ไม่ลบ Log) ใช่ไหม?')) return;
      storage.resetDay(date).then(function(ok){
        if(ok) toast('รีเซ็ตที่นั่งแล้ว', 'วันที่ ' + date);
        else toast('รีเซ็ตไม่สำเร็จ', 'ตรวจสอบ Firebase/Quota');
        render().catch(console.error);
      });
    };
  }


  async function viewBooking(dateStr, dirKey, baseTime) {
    renderNav('/');
    setStatusLine();
    var ui = loadUi();
    var date = (dateStr && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) ? dateStr : (ui.date || todayKey());
    var dir = (dirKey==='back') ? DIRS.back : DIRS.out;
    var closed = isSlotPast(date, baseTime);

    var slot = await storage.getSlot(date, dir.key, baseTime);

    var options = dir.selectable.map(function(p){
      return '<option value="' + escapeHtml(p.key) + '">' + escapeHtml(p.name) + '</option>';
    }).join('');

    $('view').innerHTML =
      '<section class="card">' +
        '<div class="card-h">' +
          '<div><h2>' + escapeHtml(dir.label) + ' • วันที่ <span style="color:var(--gold2)">' + escapeHtml(date) + '</span> • รอบเวลา <span style="color:var(--gold2)">' + escapeHtml(baseTime) + '</span></h2>' +
          '<p class="hint">เลือก ' + escapeHtml(dir.selectLabel) + ' ก่อน แล้วระบบจะแสดงเวลาถึง</p></div>' +
          '<div class="row"><button class="btn ghost" onclick="window.__back()">ย้อนกลับ</button></div>' +
        '</div>' +
        '<div class="card-b" style="max-width: 860px;">' +
          '<div class="row" style="gap:12px">' +
            '<div class="field" style="flex:1 1 360px">' +
              '<label for="place">' + escapeHtml(dir.selectLabel) + '</label>' +
              '<select id="place"><option value="">— โปรดเลือก —</option>' + options + '</select>' +
            '</div>' +
            '<div class="field" style="flex:1 1 260px">' +
              '<label>เวลาถึงโดยประมาณ</label>' +
              '<input id="arrival" readonly value="—" />' +
            '</div>' +
          '</div>' +
          '<div class="note" id="routeNote">เลือก ' + escapeHtml(dir.selectLabel) + ' เพื่อคำนวณเวลา</div>' +
          '<div class="divider"></div>' +
          '<div class="row" style="gap:12px">' +
            '<div class="field" style="flex:1 1 260px">' +
              '<label for="room">เลขห้อง</label>' +
              '<input id="room" autocomplete="off" placeholder="เช่น A105" />' +
            '</div>' +
            '<div class="field" style="flex:0 0 240px">' +
              '<label for="pax">จำนวนคน</label>' +
              '<input id="pax" type="number" min="1" step="1" inputmode="numeric" placeholder="เช่น 2" />' +
            '</div>' +
          '</div>' +
          '<div style="height:12px"></div>' +
          '<div class="row">' +
            '<button id="btnBook" class="btn primary" onclick="window.__book()">จอง</button>' +
            '<button class="btn danger" onclick="window.__cancel()">ยกเลิกการจอง</button>' +
            '<span class="pill"><span class="dot"></span> 1 ห้อง/1 รอบ จองได้ครั้งเดียว</span>' +
          '</div>' +
          '<div class="mini" id="mini"></div>' +
          '<div class="note" id="note"></div>' +
          '<div class="divider"></div>' +
          '<div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14);">' +
            '<div class="card-h" style="border-bottom-color: rgba(131,106,69,.10)"><div><h2 style="font-size:15.5px">รายการจองในรอบนี้</h2><p class="hint">แสดงเลขห้อง/จำนวนคน/เส้นทาง/เวลาถึง</p></div></div>' +
            '<div class="card-b" id="bookingsTable"></div>' +
          '</div>' +
        '</div>' +
      '</section>';

    var placeEl = $('place');
    var arrivalEl = $('arrival');
    var routeNoteEl = $('routeNote');
    var roomEl = $('room');
    var paxEl = $('pax');
    var bookBtn = $('btnBook');
    var noteEl = $('note');

    function updateArrival() {
      var t = calcTimes(dir.key, baseTime, placeEl.value);
      if(!t) {
        arrivalEl.value = '—';
        routeNoteEl.textContent = 'เลือก ' + dir.selectLabel + ' เพื่อคำนวณเวลา';
        return;
      }
      if(dir.key === 'out') {
        arrivalEl.value = 'ถึง ' + t.destination + ' ' + t.arriveTime;
        routeNoteEl.innerHTML = 'ออกจาก <b>' + escapeHtml(t.pickup) + '</b> เวลา <b>' + escapeHtml(t.pickupTime) + '</b> • ถึง <b>' + escapeHtml(t.destination) + '</b> เวลา <b>' + escapeHtml(t.arriveTime) + '</b>';
      } else {
        arrivalEl.value = 'ถึง Hotel ' + t.arriveTime;
        routeNoteEl.innerHTML = 'รับที่ <b>' + escapeHtml(t.pickup) + '</b> เวลา <b>' + escapeHtml(t.pickupTime) + '</b> • ถึง <b>Hotel</b> เวลา <b>' + escapeHtml(t.arriveTime) + '</b>';
      }
    }

    function renderBookings(slotData) {
      var sl = slotData || {};
      var b = sl.bookings || {};
      // รองรับข้อมูลเก่าที่อาจไม่มี field room ใน booking object
      var entries = Object.keys(b).map(function(k){
        var obj = b[k];
        if(obj && typeof obj === 'object') {
          if(!obj.room) obj.room = k;
          if(obj.pax === undefined && obj.pax !== 0 && obj.people !== undefined) obj.pax = obj.people;
          return obj;
        }
        // กรณีบันทึกมาเป็นเลข pax อย่างเดียว
        if(typeof obj === 'number') return { room: k, pax: obj };
        return null;
      }).filter(function(x){ if(!x) return false; var p = Number(x.pax); return Number.isFinite(p) && p > 0; });

      entries.sort(function(a,c){ return String(a.room||'').localeCompare(String(c.room||'')); });

      var wrap = $('bookingsTable');
      if(entries.length === 0) {
        wrap.innerHTML = '<div class="mini">ยังไม่มีการจองในรอบนี้</div>';
        return;
      }

      var rows = entries.map(function(obj){
        var room = obj.room || '';
        var pax = (obj.pax !== undefined && obj.pax !== null) ? obj.pax : '';
        var line = (obj.pickup && obj.destination) ? (obj.pickup + ' → ' + obj.destination) : '';
        var arrive = obj.arriveTime ? ('ถึง ' + obj.arriveTime) : '';
        return '<tr><td>' + escapeHtml(room) + '</td><td><b>' + escapeHtml(pax) + '</b></td><td>' + escapeHtml(line) + '</td><td>' + escapeHtml(arrive) + '</td></tr>';
      }).join('');

      wrap.innerHTML = '<table><thead><tr><th>เลขห้อง</th><th>จำนวนคน</th><th>เส้นทาง</th><th>เวลาถึง</th></tr></thead><tbody>' + rows + '</tbody></table>';
    }

    function updateMini(slotData) {
      var sl = slotData;
      var closedNow = isSlotPast(date, baseTime);
      $('mini').innerHTML = '<b>คงเหลือ:</b> ที่นั่งว่าง <b class="' + (sl.available===0?'danger':'') + '">' + sl.available + '</b> / ' + sl.capacity + (closedNow ? ' • <span style="color: rgba(245,240,230,.55)"><b>ปิดทำรายการแล้ว</b></span>' : '') + '<br/><span style="color:var(--muted)">Tip: หากต้องการเปลี่ยนจำนวนหรือเปลี่ยนจุด ให้ยกเลิกจนเหลือ 0 แล้วจองใหม่</span>';
    }

    function updateBookBtn(slotData) {
      var isFull = (slotData && typeof slotData.available === 'number' && slotData.available <= 0);
      var room = String(roomEl.value||'').trim();

      // ถ้ารอบนี้เต็ม: ยังเข้าไปดู/ยกเลิกได้ แต่ไม่ให้จองเพิ่ม
      if(!room) {
        if(isFull) {
          bookBtn.disabled = true;
          noteEl.textContent = 'รอบนี้ที่นั่งเต็ม (ดูรายการ/ยกเลิกได้)';
        } else {
          bookBtn.disabled = false;
          noteEl.textContent = '';
        }
        return;
      }

      var roomK = safeKey(room);
      var ex = slotData.bookings && slotData.bookings[roomK];
      var booked = ex ? (ex.pax||0) : 0;

      if(booked > 0) {
        bookBtn.disabled = true;
        var placeText = (ex.pickup && ex.destination) ? (ex.pickup + ' → ' + ex.destination) : '';
        noteEl.innerHTML = 'ห้อง <b>' + escapeHtml(room) + '</b> จองแล้ว <b>' + booked + '</b> คนในรอบนี้' + (placeText ? (' (' + escapeHtml(placeText) + ')') : '') + ' — กันการกดซ้ำ';
        return;
      }

      if(isFull) {
        bookBtn.disabled = true;
        noteEl.textContent = 'รอบนี้ที่นั่งเต็ม (ดูรายการ/ยกเลิกได้)';
      } else {
        bookBtn.disabled = false;
        noteEl.textContent = '';
      }
    }

    async function refresh() {
      var sl = await storage.getSlot(date, dir.key, baseTime);
      updateArrival();
      updateMini(sl);
      updateBookBtn(sl);
      renderBookings(sl);
      return sl;
    }

    placeEl.addEventListener('change', function(){ updateArrival(); });
    roomEl.addEventListener('input', function(){ refresh().catch(console.error); });

    window.__back = function(){ setHash('/'); };

    window.__book = async function(){
      var placeKey = String(placeEl.value||'').trim();
      var room = String(roomEl.value||'').trim();
      var pax = parseInt(paxEl.value,10);
      if(!placeKey) { toast('ข้อมูลไม่ครบ','กรุณาเลือก ' + dir.selectLabel); return; }
      if(!room) { toast('ข้อมูลไม่ครบ','กรุณาใส่เลขห้อง'); return; }
      if(!Number.isFinite(pax) || pax<=0) { toast('ข้อมูลไม่ครบ','กรุณาใส่จำนวนคน'); return; }
      var t = calcTimes(dir.key, baseTime, placeKey);
      if(!t) { toast('ข้อมูลไม่ถูกต้อง','ไม่สามารถคำนวณเวลาได้'); return; }

      bookBtn.disabled = true;
      var res = await storage.book(date, dir.key, baseTime, room, pax, placeKey, t);
      if(!res.ok) { toast('จองไม่สำเร็จ', res.msg||''); await refresh(); return; }
      toast('จองสำเร็จ', dir.label + ' • ห้อง ' + room + ' • ' + pax + ' คน • ถึง ' + t.arriveTime);
      await refresh();
    };

    window.__cancel = async function(){
      var room = String(roomEl.value||'').trim();
      var pax = parseInt(paxEl.value,10);
      if(!room) { toast('ข้อมูลไม่ครบ','กรุณาใส่เลขห้อง'); return; }
      if(!Number.isFinite(pax) || pax<=0) { toast('ข้อมูลไม่ครบ','กรุณาใส่จำนวนคน'); return; }
      var res = await storage.cancel(date, dir.key, baseTime, room, pax);
      if(!res.ok) { toast('ยกเลิกไม่สำเร็จ', res.msg||''); await refresh(); return; }
      toast('ยกเลิกสำเร็จ', 'คืนที่นั่ง ' + pax + ' คน • ห้อง ' + room);
      await refresh();
    };

    await refresh();
  }

  async function viewLogs() {
    renderNav('/logs');
    setStatusLine();
    var date = (loadUi().date || todayKey());
    var monthKey = monthKeyFromDateStr(date);
    var stats = await storage.getStatsMonth(monthKey);

    function val(dirKey, t) {
      var k = timeKey(t);
      return (stats[dirKey] && typeof stats[dirKey][k] === 'number') ? stats[dirKey][k] : 0;
    }

    var outTop = { time:null, value:0 };
    DIRS.out.baseTimes.forEach(function(t){ var v = val('out',t); if(v>outTop.value) outTop={time:t,value:v}; });
    var backTop = { time:null, value:0 };
    DIRS.back.baseTimes.forEach(function(t){ var v = val('back',t); if(v>backTop.value) backTop={time:t,value:v}; });

    var recent = await storage.queryLogs({ mode:'all', limit: 250 });

    function buildBars(map, times) {
      map = map || {};
      var maxVal = 0;
      times.forEach(function(t){ var v = map[timeKey(t)] || 0; if(v>maxVal) maxVal=v; });
      return times.map(function(t){
        var v = map[timeKey(t)] || 0;
        var w = maxVal ? Math.round((v/maxVal)*100) : 0;
        return '<div class="bar">' +
          '<div class="lbl">'+escapeHtml(t)+'</div>' +
          '<div class="track"><div class="fill" style="width:'+w+'%"></div></div>' +
          '<div class="num">'+v+'</div>' +
        '</div>';
      }).join('');
    }

    var rows = recent.map(function(e){
      var ts = e.tsMs ? new Date(e.tsMs).toLocaleString() : '';
      var action = (e.action === 'BOOK')
        ? '<span style="color:var(--ok);font-weight:900">BOOK</span>'
        : '<span style="color:var(--danger);font-weight:900">CANCEL</span>';
      var dir = e.dir === 'out' ? 'ขาไป' : (e.dir === 'back' ? 'ขากลับ' : (e.dir||''));
      var route = (e.pickup && e.destination) ? (e.pickup + ' → ' + e.destination) : '';
      return '<tr>'+
        '<td>'+escapeHtml(ts)+'</td>'+
        '<td>'+action+'</td>'+
        '<td>'+escapeHtml(dir)+'</td>'+
        '<td>'+escapeHtml(e.time||'')+'</td>'+
        '<td>'+escapeHtml(route)+'</td>'+
        '<td>'+escapeHtml(e.arriveTime||'')+'</td>'+
        '<td>'+escapeHtml(e.room||'')+'</td>'+
        '<td><b>'+escapeHtml((typeof e.pax==='number')?e.pax:(e.pax||''))+'</b></td>'+
      '</tr>';
    }).join('\n');

    $('view').innerHTML =
      '<section class="card">' +
        '<div class="card-h">' +
          '<div><h2>บันทึก/สถิติ</h2><p class="hint">เดือน <b>'+escapeHtml(monthKey)+'</b> • Export แยก วัน/เดือน/ทั้งหมด ได้</p></div>' +
          '<div class="row"><button class="btn ghost" onclick="window.__goSchedule()">กลับหน้าตาราง</button></div>' +
        '</div>' +
        '<div class="card-b">' +
          '<div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14); margin-bottom: 12px;">' +
            '<div class="card-b">' +
              '<div class="row" style="align-items:flex-end; justify-content:space-between">' +
                '<div class="row" style="flex:1;">' +
                  '<div class="field" style="max-width:230px"><label for="expDay">Export ตามวัน</label><input id="expDay" type="date" /></div>' +
                  '<button class="btn" onclick="window.__exportDayFromInput()">Export วัน</button>' +
                  '<div class="field" style="max-width:230px"><label for="expMonth">Export ตามเดือน</label><input id="expMonth" type="month" /></div>' +
                  '<button class="btn" onclick="window.__exportMonthFromInput()">Export เดือน</button>' +
                '</div>' +
                '<div class="row"><button class="btn" onclick="window.__exportAll()">Export ทั้งหมด</button></div>' +
              '</div>' +
              '<div class="mini">หมายเหตุ: Export วัน/เดือน จะดึง log จาก Firebase ตามช่วงเวลา • ถ้าข้อมูลเยอะอาจใช้เวลาสักครู่</div>' +
            '</div>' +
          '</div>' +

          '<div class="grid">' +
            '<div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14);">' +
              '<div class="card-h" style="border-bottom-color: rgba(131,106,69,.10)"><div><h2 style="font-size:15.5px">สถิติ • ขาไป</h2><p class="hint">เวลาที่จองเยอะสุด: <b>'+(outTop.time||'—')+'</b> ('+outTop.value+' คน)</p></div></div>' +
              '<div class="card-b">'+ buildBars(stats.out, DIRS.out.baseTimes) +'</div>' +
            '</div>' +
            '<div class="card" style="background: rgba(7,18,31,.25); border-color: rgba(131,106,69,.14);">' +
              '<div class="card-h" style="border-bottom-color: rgba(131,106,69,.10)"><div><h2 style="font-size:15.5px">สถิติ • ขากลับ</h2><p class="hint">เวลาที่จองเยอะสุด: <b>'+(backTop.time||'—')+'</b> ('+backTop.value+' คน)</p></div></div>' +
              '<div class="card-b">'+ buildBars(stats.back, DIRS.back.baseTimes) +'</div>' +
            '</div>' +
          '</div>' +

          '<div class="divider"></div>' +

          '<table>' +
            '<thead><tr><th>เวลา</th><th>Action</th><th>ขา</th><th>รอบ</th><th>เส้นทาง</th><th>ถึง</th><th>ห้อง</th><th>คน</th></tr></thead>' +
            '<tbody>' + (rows || '<tr><td colspan="8" class="mini">ยังไม่มี Log</td></tr>') + '</tbody>' +
          '</table>' +
        '</div>' +
      '</section>';

    var dayEl = $('expDay');
    var monthEl = $('expMonth');
    if(dayEl) dayEl.value = (loadUi().date || todayKey());
    if(monthEl) monthEl.value = monthKeyFromDateStr(loadUi().date || todayKey());

    window.__exportDayFromInput = function(){
      var v = (dayEl && dayEl.value) ? dayEl.value : (loadUi().date || todayKey());
      doExport('day', v).catch(console.error);
    };
    window.__exportMonthFromInput = function(){
      var v = (monthEl && monthEl.value) ? monthEl.value : monthKeyFromDateStr(loadUi().date || todayKey());
      doExport('month', v).catch(console.error);
    };
    window.__exportAll = function(){ doExport('all','').catch(console.error); };

    window.__goSchedule = function(){ setHash('/'); };
  }

  // ============================
  // Router
  // ============================
  async function render() {
    var h = parseHash();
    if(h.path === '/logs') return viewLogs();
    if(h.path === '/book') {
      var d = h.params.get('date') || (loadUi().date || todayKey());
      if(d && /^\d{4}-\d{2}-\d{2}$/.test(d)) {
        var ui2 = loadUi();
        ui2.date = d;
        saveUi(ui2);
      } else {
        d = loadUi().date || todayKey();
      }
      var dir = h.params.get('dir') || 'out';
      var t = h.params.get('time') || '';
      return viewBooking(d, dir==='back'?'back':'out', t);
    }
    return viewSchedule();
  }

  // ============================
  // Init
  // ============================
  async function boot() {
    if(!location.hash) location.hash = '#/';
    await storage.initFirebase(); // try firebase first
    window.addEventListener('hashchange', function(){ render().catch(console.error); });
    render().catch(console.error);
  }

  boot().catch(console.error);

})();
</script>
</body>
</html>
